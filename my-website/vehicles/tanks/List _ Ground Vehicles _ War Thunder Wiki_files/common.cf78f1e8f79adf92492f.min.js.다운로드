"use strict";(self.webpackChunkwt_wiki_3=self.webpackChunkwt_wiki_3||[]).push([[76],{997:(e,t,i)=>{var n=i(648),s=i(202);class a{constructor(e){this.post_id=e}async bookmark(e){var t=new FormData;return t.append("post_id",this.post_id),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),!0===e?t.append("flag",1):t.append("flag",0),(0,s.A)("/api/bookmark",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)return e;throw new Error(e.message)}))}}class o{constructor(e){this.post_id=e}async vote(e){var t=new FormData;return t.append("post_id",this.post_id),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),!0===e?t.append("vote",1):null===e?t.append("vote",0):reject({success:!1,message:window.app.l10n("core.bad-request-error")}),(0,s.A)("/api/vote",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)return e;throw new Error(e.message)}))}}var r=i(400);const l="feed";class d{static init(e,t={}){for(var i in e.dataset)if(i.startsWith("feed")){var n=i.slice(4);t[n=(n=n.charAt(0).toLowerCase()+n.slice(1)).replace(/[A-Z]/g,(e=>"_"+e.toLowerCase()))]=e.dataset[i]}return new d(e,t)}constructor(e,t={}){if(this.atributes=t,this.id=this.atributes.id||null,delete this.atributes.id,!this.id)return;this.entryIds=[],this.nodes={root:e,itemsContainer:e.querySelector(`.${l}__items`),btnLoadNew:e.querySelector(`.${l}__load-new`),blockEndList:e.querySelector(`.${l}__end-entry`),blockEmpty:e.querySelector(`.${l}__empty`)};let i=this.nodes.root.querySelectorAll(`.${l}__items > *`);if(i.forEach((e=>{this._initFeedItem(e)})),this.start=this.atributes.start??Math.floor(Date.now()/1e3),delete this.atributes.start,"false"===this.atributes.hasmore)this.nodes.btnLoadNew.classList.add("d-none"),this.nodes.blockEmpty&&0===i.length?this.nodes.blockEmpty.classList.remove("d-none"):this.nodes.blockEndList.classList.remove("d-none");else if(this.nodes.btnLoadNew.addEventListener("click",(()=>{this.more()})),i.length>0){let e=i[i.length-1];this.observeScroll(e)}else this.observeScroll(this.nodes.btnLoadNew);delete this.atributes.hasmore}_initFeedItem(e){if(e.hasAttribute("data-entry-id")&&this.entryIds.push(e.getAttribute("data-entry-id")),e.classList.contains("post")){let t=Number(e.getAttribute("data-feed-pid"));if(t<=0)return;const i=new a(t);e.querySelectorAll(".post-bookmark").forEach((t=>{t.addEventListener("click",(()=>{if(e.bookmarkSend)return;if(null===window.app.getLoginUser())return void window.GSEA?.open();let t;t=!e.classList.contains("post--with-bookmark"),e.bookmarkSend=!0,i.bookmark(t).then((t=>{e.classList.toggle("post--with-bookmark",t.data.bookmark);let i=window.app.getLang();e.querySelectorAll(".post-bookmark .value").forEach((e=>{e.innerText=new Intl.NumberFormat(i).format(t.data.count)})),e.bookmarkSend=!1})).catch((t=>{window.app.error(t.message),e.bookmarkSend=!1}))}))}));const n=new o(t),s=e.querySelector(".post-like");s.addEventListener("click",(()=>{if(null===window.app.getLoginUser())return void window.GSEA?.open();const t=!e.classList.contains("post--liked")||null;n.vote(t).then((t=>{const i=s.querySelector(".value");1===t.data.vote?e.classList.add("post--liked"):e.classList.remove("post--liked");const n=window.app.getLang();i&&(null!==t.data.rating?i.innerText=new Intl.NumberFormat(n).format(t.data.rating):i.innerText="0")})).catch((e=>{window.app.error(e.message)}))}))}}observeScroll(e){if(!this.observer){let e={threshold:.5};this.observer=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(this.more(),t.unobserve(e.target))}))}),e)}this.observer.observe(e)}_isLoadingMore=!1;async more(){if(this._isLoadingMore)return;this._isLoadingMore=!0,this.nodes.btnLoadNew.classList.add("loading");let e=this.nodes.btnLoadNew.innerText;this.nodes.btnLoadNew.innerHTML=r.A;let t=new URL(`/api/feed/${this.id}`,window.location.origin),i=this.nodes.root.querySelectorAll(`.${l}__items > *`);i.length>0&&t.searchParams.set("offset",i.length),t.searchParams.set("start",this.start);for(let e in this.atributes)null!==this.atributes[e]&&t.searchParams.set(e,this.atributes[e]);return(0,s.A)(t).then((e=>{let t=0;e.entries.forEach((e=>{let i=document.createElement("template");i.innerHTML=e;let n=i.content.firstChild;n&&(n.hasAttribute("data-entry-id")&&this.entryIds.includes(n.getAttribute("data-entry-id"))||(this.nodes.itemsContainer.append(n),this._initFeedItem(n),t++))})),e.hasMore&&t>0?this.observeScroll(this.nodes.itemsContainer.lastChild):(this.nodes.btnLoadNew.classList.add("d-none"),this.nodes.blockEmpty&&i.length+t===0?this.nodes.blockEmpty.classList.remove("d-none"):this.nodes.blockEndList.classList.remove("d-none"))})).finally((()=>{this._isLoadingMore=!1,this.nodes.btnLoadNew.classList.remove("loading"),this.nodes.btnLoadNew.innerText=e}))}refresh(){this.nodes.blockEmpty?.classList.add("d-none"),this.nodes.blockEndList?.classList.add("d-none"),this.nodes.btnLoadNew?.classList.remove("d-none"),this.nodes.itemsContainer.innerHTML="",this.more()}}class c{static init(){0!==document.querySelectorAll(".block-image, .block-gallery, .tip-content_image").length&&window.app.loadModule("photoswipe").then((({default:e})=>{const t=new e.PhotoSwipeLightbox({gallery:".block-image .block-image__container a, a.tip-content_image",pswpModule:e.PhotoSwipe});t.on("uiRegister",(function(){t.pswp.ui.registerElement(e.downloadButtonConfig)})),t.init();const i=new e.PhotoSwipeLightbox({gallery:".block-gallery .block-gallery__container",children:"a",pswpModule:e.PhotoSwipe});i.on("uiRegister",(function(){i.pswp.ui.registerElement(e.downloadButtonConfig)})),i.init()}));let e=document.querySelectorAll(".block-gallery__container.swiper");0!==e.length&&window.app.loadModule("swiper").then((({default:t})=>{e.forEach((e=>{new t.Swiper(e,{slidesPerView:"auto",spaceBetween:30,centeredSlides:!0,pagination:{el:".swiper-pagination",clickable:!0}})}))}));let t=document.querySelectorAll(".block-panorama");0!==t.length&&window.app.loadModule("pannellum").then((({default:e})=>{t.forEach((e=>{let t=e.querySelector(".block-panorama_container");t.hasAttribute("data-url")&&(t.innerHTML="",t.classList.remove("placeholder-glow"),window.pannellum.viewer(t,{type:"equirectangular",panorama:t.getAttribute("data-url"),strings:window.app.l10n("pannellum")}))}))}));let i=document.querySelector(".content");i&&(i.addEventListener("click",(e=>{const t=e.target.closest("span.cdx-annotation");t&&(t.classList.contains("active")?c.closeAnnotationPopover():(c.openAnnotationPopover(t),document.querySelectorAll("span.cdx-annotation.active").forEach((e=>{e!==t&&e.classList.remove("active")}))))})),document.addEventListener("click",(e=>{const t=e.target.closest("span.cdx-annotation"),i=e.target.closest(".c-annotation_block");t||i||c.closeAnnotationPopover()})),window.addEventListener("scroll",(()=>{c.closeAnnotationPopover()})))}static getAnnotationPopover(){let e=document.getElementById("c-annotation");if(!e){e=document.createElement("div"),e.id="c-annotation",e.classList.add("c-annotation","hidden");let t=document.createElement("div");t.classList.add("c-annotation_overlay");let i=document.createElement("div");i.classList.add("c-annotation_block");let n=document.createElement("div");n.classList.add("c-annotation_title");let s=document.createElement("div");s.classList.add("c-annotation_content","content-markdown"),i.appendChild(n),i.appendChild(s),e.appendChild(t),e.appendChild(i),document.querySelector(".content").after(e)}return e}static getFromNodePos(e,t){for(var i=0,n=0;i+=e.offsetLeft,n+=e.offsetTop,null!==e.offsetParent&&e.offsetParent!==t;)e=e.offsetParent;return[i,n]}static openAnnotationPopover(e){e.classList.add("active");let t=c.getAnnotationPopover(),i=t.querySelector(".c-annotation_title");i&&(e.hasAttribute("data-title")?i.innerText=e.getAttribute("data-title"):i.innerText="");let n=t.querySelector(".c-annotation_content");n&&(e.hasAttribute("data-html")?n.innerHTML=e.getAttribute("data-html"):n.innerHTML="");let s=c.getFromNodePos(e,e.closest(".content").parentElement);t.style.top=s[1]-90+"px",t.classList.remove("hidden")}static closeAnnotationPopover(){document.querySelectorAll("span.cdx-annotation.active").forEach((e=>{e.classList.remove("active")}));const e=document.getElementById("c-annotation");e&&e.classList.add("hidden")}}var u=i(336),m=i(41),h=i(267);class p{constructor(e,t){this.commentsSection=t,this.postId=e;let i=t.querySelector(".comments-writing .comment-form");i&&(this._initCommentForm(i),this.commentForm=i);let n=t.querySelector(".comments-content");this.commentsContent=n,document.querySelectorAll(".comment").forEach((e=>{this._initComment(e)})),n.addEventListener("click",(e=>{if(e.target.closest(".comment_reply")){var t=e.target.closest(".comment"),i=t.querySelector(".comment-form");i?i.classList.toggle("d-none"):this._getReplyForm(t).setAttribute("data-reply",t.getAttribute("data-comment-id"))}})),n.addEventListener("click",(e=>{let t=e.target.closest(".comment_add-reaction .comment_button");if(t&&null===window.app.getLoginUser())return u.Dropdown.getOrCreateInstance(t).hide(),void window.app.info(window.app.l10n("unauthorized-error.vote"))})),n.addEventListener("click",(e=>{let t=e.target.closest(".comment_reaction-button");if(t){let i=e.target.closest(".comment"),n=parseInt(i.getAttribute("data-comment-id")),s=parseInt(t.getAttribute("data-reaction-id"));this.reaction(n,s)}})),document.addEventListener("click",(e=>{var t=e.target.closest("[data-menu-id]");if(!t)return;let i=e.target.closest(".comment");if(!i)return;let n=t.getAttribute("data-menu-id");switch(n){case"pin":case"unpin":this._pin(i.getAttribute("data-comment-id"),n);break;case"delete":this._delete(i.getAttribute("data-comment-id"));break;case"edit":this._fillCommentSource(i)}})),n.addEventListener("click",(e=>{let t=e.target.closest("[data-reply-comment-id]");if(t){let i=t.getAttribute("data-reply-comment-id"),n=document.getElementById(`comment_${i}`);n&&(e.preventDefault(),n.classList.add("comment--highlight"),window.location.hash=`#comment_${i}`,setTimeout((()=>n.classList.remove("comment--highlight")),500))}})),this.isSliceShow=t.hasAttribute("data-comment"),this.isSliceShow||new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(this.loadMoreThreads(),t.unobserve(e.target))}))}),{threshold:0}).observe(t),"moderation"===this.commentsSection.getAttribute("data-section")&&n.addEventListener("click",(e=>{let t=e.target.closest(".comment_moderation-button");if(t){let i=e.target.closest(".comment"),n=t.getAttribute("data-action");this._moderation(i,n)}}));let s=t.querySelector(".comment-update");s&&(s.addEventListener("click",(()=>{this.loadMoreThreads()})),this.buttonCommentUpdate=s),document.addEventListener("app.comment.mod.delete",(e=>{let t=e=>{let t=e.closest(".comments-thread"),i=e.closest(".comments-branch");i?(e.remove(),i&&0==i.childElementCount&&i.remove()):t&&t.childElementCount<=1?t.remove():(e.style.filter="blur(5px)",e.style.pointerEvents="none")},i=e.detail,n=document.querySelector(`[data-comment-id="${i.commentId}"]`);n&&t(n),i.affectedIds&&i.affectedIds.forEach((e=>{let i=document.querySelector(`[data-comment-id="${e}"]`);i&&t(i)}))}))}_initCommentForm(e){new h.A(e,{target:"p-c_"+this.postId,onSend:async(e,t)=>{let i={};return t.hasAttribute("data-edit")?i.edit_id=t.getAttribute("data-edit"):(t.hasAttribute("data-reply")&&(i.reply=t.getAttribute("data-reply")),t.hasAttribute("data-section")&&(i.section=t.getAttribute("data-section"))),"text"in e&&(i.text=e.text.trim()),"img-uuid"in e&&(i["img-uuid"]=e["img-uuid"]),this.sendComment(i)}})}_initComment(e){let t=e.querySelector(".comment_image");t&&window.app.loadModule("photoswipe").then((({default:e})=>{const i=new e.PhotoSwipeLightbox({gallery:t,pswpModule:e.PhotoSwipe});i.on("uiRegister",(function(){i.pswp.ui.registerElement(e.downloadButtonConfig)})),i.init()}));let i=e.querySelector(".comment_add-reaction");if(i&&e.hasAttribute("data-reaction-id")){let t=parseInt(e.getAttribute("data-reaction-id")),n=e.querySelector(`.comment_reaction-button[data-reaction-id="${t}"]`);if(n){i.classList.add("d-none");let t=document.createElement("button");t.classList.add("comment_button","comment_remove-reaction"),t.innerHTML=n.innerHTML,t.addEventListener("click",(()=>{this.reaction(e.getAttribute("data-comment-id"),null)})),i.parentElement.prepend(t)}}let n=e.querySelector(".comment_text");n&&"height-cropper"===n.getAttribute("data-module")&&m.A.call(n),[...e.querySelectorAll('[data-bs-toggle="tooltip"]')].map((e=>new u.Tooltip(e,{trigger:"hover"})))}_lastTimestamp=null;_doingMore=!1;async loadMoreThreads(){if(this.isSliceShow)return;if(this._doingMore)return;this._doingMore=!0,this.buttonCommentUpdate&&(this.buttonCommentUpdate.dataLabel=this.buttonCommentUpdate.innerText,this.buttonCommentUpdate.innerHTML=r.A);let e=new FormData;e.append(window.app.getCSRFParam(),window.app.getCSRFToken()),e.append("post_id",this.postId),e.append("section",this.commentsSection.getAttribute("data-section"));let t=this.commentsSection.querySelector("#post-comment-sort");if(t){let i=t.querySelector(".dropdown-item.active");i&&e.append("sort",i.getAttribute("data-sort-id"))}this._lastTimestamp&&e.append("timestamp",this._lastTimestamp);let i=this.commentsContent.querySelectorAll(".comments-thread:not(.comments-thread--pinned)").length;return i>0&&e.append("offset",i),(0,s.A)("/api/commentsGetThreads",{method:"POST",credentials:"include",body:e}).then((e=>{e.success?this._renderMoreThreads(e.data):window.app.error(e.message)})).finally((e=>{this._doingMore=!1,this.buttonCommentUpdate&&(this.buttonCommentUpdate.innerText=this.buttonCommentUpdate.dataLabel)}))}_renderMoreThreads(e){let t=this.commentsContent.querySelectorAll(".comments-thread:not(.comments-thread--pinned) > .comment"),i=[];t.forEach((e=>{i.push(parseInt(e.getAttribute("data-comment-id")))})),e.items.forEach((e=>{if(-1!==i.indexOf(e.id))return;let t=document.createElement("div");if(t.classList.add("comments-thread"),t.innerHTML=e.html,this.commentsContent.appendChild(t),this._initComment(t.lastChild),e.child_items){let i=document.createElement("div");i.classList.add("comments-branch"),e.child_items.forEach((e=>{i.insertAdjacentHTML("beforeEnd",e.html),this._initComment(i.lastChild)}));let n=e.total_items-e.child_items.length;if(n>0){let t=document.createElement("button");t.classList.add("btn","btn-link","comments-more"),t.innerText=window.app.l10n("comment.load_more",{count:n}),t.addEventListener("click",(()=>{let i=document.createElement("span");i.className="spinner-border spinner-border-sm me-2",i.role="status",t.prepend(i),this.loadBranch(e.id).finally((()=>{t.remove()}))})),i.appendChild(t)}t.appendChild(i)}}));let n=e.threads-i.length-e.items.length;if(n>0){let e=document.createElement("button");e.classList.add("btn","btn-link","comments-more"),e.innerText=window.app.l10n("comment.load_more",{count:n}),e.addEventListener("click",(()=>{let t=document.createElement("span");t.className="spinner-border spinner-border-sm me-2",t.role="status",e.prepend(t),this.loadMoreThreads().finally((()=>{e.remove()}))})),this.commentsContent.appendChild(e)}}async loadBranch(e){if(this.isSliceShow)return;let t=this.commentsContent.querySelector(`.comments-thread > #comment_${e}`);if(!t)return;if(t._doingMore)return;t._doingMore=!0;let i=t.parentElement,n=new FormData;n.append(window.app.getCSRFParam(),window.app.getCSRFToken()),n.append("root_id",e);let a=i.querySelectorAll(".comments-branch .comment"),o=[];return a.forEach((e=>{o.push(parseInt(e.getAttribute("data-comment-id")))})),n.append("offset",a.length),(0,s.A)("/api/commentsGetBranch",{method:"POST",credentials:"include",body:n}).then((t=>{if(t.success){let n=i.querySelector(".comments-branch");n||(n=document.createElement("div"),n.className="comments-branch",i.appendChild(n)),t.data.items.forEach((e=>{-1===o.indexOf(e.id)&&(n.insertAdjacentHTML("beforeEnd",e.html),this._initComment(n.lastChild))}));let s=t.data.total_items-t.data.items.length-a;if(s>0){let t=document.createElement("button");t.classList.add("btn","btn-link","comments-more"),t.innerText=window.app.l10n("comment.load_more",{count:s}),t.addEventListener("click",(()=>{let i=document.createElement("span");i.className="spinner-border spinner-border-sm me-2",i.role="status",t.prepend(i),this.loadBranch(e).finally((()=>{t.remove()}))})),n.appendChild(t)}}else window.app.error(t.message)})).finally((e=>{t._doingMore=!1}))}async sendComment(e){if(!("text"in e&&0!==e.text.trim().length||"img-uuid"in e))return window.app.warning(window.app.l10n("comment.error_empty")),Promise.reject();var t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("post_id",this.postId),"text"in e&&t.append("text",e.text.trim()),"img-uuid"in e&&t.append("img-uuid",e["img-uuid"]),"section"in e&&t.append("section",e.section),"reply"in e&&t.append("reply",e.reply),"edit_id"in e&&t.append("edit_id",e.edit_id),(0,s.A)("/api/commentSend",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)if(e?.data?.newHTML){let t=this.commentsSection.querySelector(`.comment[data-comment-id="${e.data.commentId}"]`);t?(t.outerHTML=e.data.newHTML,this._initComment(t)):window.location.reload()}else window.location.reload();else window.app.warning(e.message)}))}reaction(e,t){var i=new FormData;i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("comment_id",e),i.append("reaction",null===t?-1:t),(0,s.A)("/api/commentReaction",{method:"POST",credentials:"include",body:i}).then((t=>{t.success?this.commentsContent.querySelectorAll(`[data-comment-id='${e}']`).forEach((e=>{e.querySelectorAll(".comment_reaction").forEach((e=>{let i=parseInt(e.getAttribute("data-reaction-id")),n=t.data.counters[i]||0;n>0?(e.classList.remove("d-none"),e.querySelector("span").innerText=n):i===t.data.reaction?(e.classList.remove("d-none"),e.querySelector("span").innerText=""):e.classList.add("d-none"),e.classList.toggle("active",i===t.data.reaction)}));let i=e.querySelector(".comment_add-reaction");if(e.querySelector(".comment_remove-reaction")?.remove(),null!==t.data.reaction){e.setAttribute("data-reaction-id",t.data.reaction),i?.classList.add("d-none");let n=e.querySelector(`.comment_reaction-button[data-reaction-id="${t.data.reaction}"]`);if(n){let t=document.createElement("button");t.classList.add("comment_button","comment_remove-reaction"),t.innerHTML=n.innerHTML,t.addEventListener("click",(()=>{this.reaction(e.getAttribute("data-comment-id"),null)})),i?.parentElement.prepend(t)}}else e.removeAttribute("data-reaction-id"),i?.classList.remove("d-none")})):window.app.error(t.message)}))}_fillCommentSource(e){let t=e.getAttribute("data-comment-id");var i=new FormData;i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("comment_id",t),(0,s.A)("/api/commentGetSource",{method:"POST",credentials:"include",body:i}).then((i=>{if(i.success){let n=this._getReplyForm(e);n.classList.remove("d-none"),n.removeAttribute("data-reply"),n.setAttribute("data-edit",t);let s=e.querySelector(".comment_content"),a=e.querySelector(".comment_controls");s.classList.add("d-none"),a.classList.add("d-none");let o=JSON.parse(i.data?.source),r=n.querySelector(".comment-form_input");o.text?r.value=o.text:r.value="",n.resizeHeight();let l=n.querySelector(".comment-form_upload-file"),d=n.querySelector(".comment-form_attach-img");if(o.image){l.classList.add("d-none"),d.classList.remove("d-none"),n.setAttribute("data-img-uuid",o.image);let t=e.querySelector(".comment_image img")?.src;d.style.backgroundImage=`url(${t})`}else l.classList.remove("d-none"),d.classList.add("d-none"),n.removeAttribute("data-img-uuid");let c=document.createElement("button");c.className="btn btn-sm btn-danger bi bi-x-lg",c.addEventListener("click",(()=>{s.classList.remove("d-none"),a.classList.remove("d-none"),r.value="",n.removeAttribute("data-edit"),n.removeAttribute("data-img-uuid"),n.classList.add("d-none"),l.classList.remove("d-none"),d.classList.add("d-none"),c.remove()})),n.querySelector(".comment-form_send").before(c)}else window.app.error(i.message)}))}_getReplyForm(e){var t=e.querySelector(".comment-form");if(!t){var i=this.commentForm.cloneNode(!0);e.appendChild(i),this._initCommentForm(i),t=i}return t}_delete(e){var t=new FormData;t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("comment_id",e),(0,s.A)("/api/commentDelete",{method:"POST",credentials:"include",body:t}).then((t=>{if(t.success){window.app.success(window.app.l10n("comment.deleted"));let i=this.commentsSection.querySelector(`.comment[data-comment-id="${e}"]`);if(i)if(t?.data?.newHTML)i.outerHTML=t.data.newHTML;else{let e=i.closest(".comments-thread"),t=i.closest(".comments-branch");i.remove(),t&&0==t.childElementCount&&t.remove(),e&&0==e.childElementCount&&e.remove()}}else window.app.error(t.message)}))}_pin(e,t){var i=new FormData;i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("comment_id",e),i.append("post_id",this.postId),i.append("action",t),(0,s.A)("/api/commentPin",{method:"POST",credentials:"include",body:i}).then((e=>{e.success?window.location.reload():window.app.error(e.message)}))}_moderation(e,t){let i=e.getAttribute("data-comment-id");var n=new FormData;n.append(window.app.getCSRFParam(),window.app.getCSRFToken()),n.append("comment_id",i),n.append("post_id",this.postId),n.append("action",t),(0,s.A)("/api/commentModeration",{method:"POST",credentials:"include",body:n}).then((t=>{t.success?e.parentElement.remove():window.app.error(t.message)}))}}var g=i(252),w=i(86),v=i(193);const b="wiki-editor",f=`${b}__initial`,y=`${b}__title`,_=`${b}__instance`,L=`${b}__tags`,S=`${b}__entities`,T=`${b}__save`,k=`${b}__preview`,E=`${b}__review`,C=`${b}__typograf`,I=`${b}__save-status`,A=`${b}__saved`,M=`${b}__save-time`,q=`${b}__history`,x=`${b}__modal-history`,B=`${b}_modal-review`,P=`${b}_review-require`,F=`${b}_review-require-sym`,N=`${b}_review-require-img`,R=`${b}_review-require-tag`;class H{static getPosFromNode(e,t){let i=0,n=0;for(;i+=e.offsetLeft,n+=e.offsetTop,null!==e.offsetParent&&e.offsetParent!==t;)e=e.offsetParent;return[i,n]}constructor(e,t,i={}){this.container=e,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.canvasXY=H.getPosFromNode(this.canvas,this.container),this.arrowPadding=i.hasOwnProperty("arrowPadding")?i.arrowPadding:4,this.arrowThickness=i.arrowThickness||8}getCtx(){return this.ctx}draw(e,t){const i=H.getPosFromNode(t,this.container),n=H.getPosFromNode(e,this.container),s=this.getCtx();if(Math.abs(n[1]-i[1])<=5){if(Math.abs(i[0]-n[0])<=2)return;let a,o,r;i[0]>n[0]?(r=1,a=n[0]+e.clientWidth,o=i[0]):(r=-1,a=n[0],o=i[0]+t.clientWidth);const l=Math.round(n[1]-this.canvasXY[1]+(e.clientHeight-e.clientHeight/2)-this.arrowThickness/2),d=a-3*r,c=Math.round(d-this.canvasXY[0]),u=o-d+-2*r;s.fillRect(c,l,u,this.arrowThickness),s.beginPath(),s.moveTo(c+u,l-3),s.lineTo(c+u+7*r,l+this.arrowThickness/2),s.lineTo(c+u,l+this.arrowThickness+3),s.fill()}else if(Math.abs(n[0]-i[0])<=2){if(i[1]>n[1]){let t=Math.round(n[0]-this.canvasXY[0]+e.clientWidth/2-this.arrowThickness/2),a=n[1]+e.clientHeight+this.arrowPadding,o=Math.round(a-this.canvasXY[1]),r=i[1]-a-this.arrowPadding-7;s.fillRect(t,o,this.arrowThickness,r),s.beginPath(),s.moveTo(t-3,o+r),s.lineTo(t+this.arrowThickness/2,o+r+7),s.lineTo(t+this.arrowThickness+3,o+r),s.fill()}}else{var a=Math.round(n[0]-this.canvasXY[0]+e.clientWidth/2-this.arrowThickness/2),o=n[1]+e.clientHeight+this.arrowPadding,r=Math.round(o-this.canvasXY[1]),l=i[1]-o-this.arrowPadding;t.classList.contains("wt-tree_group")&&(height+=4),s.fillRect(a,r,this.arrowThickness,4);var d=Math.round(i[0]-this.canvasXY[0]+t.clientWidth/2-this.arrowThickness/2);i[0]<n[0]?s.fillRect(d,r+4,Math.abs(d-a)+this.arrowThickness,this.arrowThickness):s.fillRect(a,r+4,Math.abs(d-a)+this.arrowThickness,this.arrowThickness);var c=l-this.arrowThickness-4-7,u=r+4+this.arrowThickness;s.fillRect(d,u,this.arrowThickness,c),s.beginPath(),s.moveTo(d-3,u+c),s.lineTo(d+this.arrowThickness/2,u+c+7),s.lineTo(d+this.arrowThickness+3,u+c),s.fill()}}}var $=i(282);class U{static _instance=null;static getOrCreateInstance(){return U._instance||(U._instance=new U),U._instance}constructor(){const e=$.A.render('<div class="modal fade modalCreateTip" id="modalCreateTip" tabindex="-1" aria-hidden="true"> <style>.modalCreateTip_img-container{width:180px;aspect-ratio:16/9;border-radius:5px;position:relative}.modalCreateTip_img-wrapper{width:100%;height:100%;border-radius:5px;overflow:hidden}.modalCreateTip_img{width:100%;height:100%;object-fit:cover}.modalCreateTip_btn-img{width:100%;height:100%;display:flex;align-items:center;justify-content:center;border:0;background-color:var(--theme-border-color);border-radius:5px;padding:0}.modalCreateTip_btn-img:hover{background-color:var(--theme-hover-bg)}.modalCreateTip_btn-del-img{position:absolute;right:-6px;top:-6px;width:20px;height:20px;display:flex;align-items:center;justify-content:center;line-height:0;font-size:10px;border:1px solid var(--bs-red);border-radius:50%;color:var(--bs-red);background-color:var(--theme-border-color)}.modalCreateTip_btn-del-img:hover{background-color:var(--theme-hover-bg)}.modalCreateTip_rule-list li{margin-bottom:3px}.modalCreateTip_btn-open-rule{font-size:.8em}@media (min-width:1000px){.modalCreateTip .modal-dialog{--bs-modal-width:800px}.modalCreateTip .modal-body{display:grid;grid-template-columns:1fr auto 1fr;gap:1em}.modalCreateTip .modalCreateTip_section-form,.modalCreateTip .modalCreateTip_section-rule{display:block!important}.modalCreateTip .modalCreateTip_btn-open-rule,.modalCreateTip .modalCreateTip_btn-rule-accept{display:none}}@media (max-width:1000px){.modalCreateTip .vr{display:none}}</style> <div class="modal-dialog"> <div class="modal-content"> <form method="POST"> <div class="modal-header"> <h5 class="modal-title"></h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="modalCreateTip_section-rule"> <div class="mb-1" data-l10n-key="create-tip-modal.rule-title"></div> <ul class="ps-4 modalCreateTip_rule-list mb-3"> <li data-l10n-key="create-tip-modal.rule-5"></li> <li data-l10n-key="create-tip-modal.rule-1"></li> <li data-l10n-key="create-tip-modal.rule-2"></li> <li data-l10n-key="create-tip-modal.rule-3"></li> <li data-l10n-key="create-tip-modal.rule-4"></li> </ul> <button type="button" class="btn btn-outline-primary modalCreateTip_btn-rule-accept" data-l10n-key="create-tip-modal.btn-rules-accept"></button> </div> <div class="vr"></div> <div class="modalCreateTip_section-form"> <button type="button" class="btn btn-sm btn-link modalCreateTip_btn-open-rule p-0 mb-2"> <i class="bi bi-arrow-return-left me-1"></i> <span data-l10n-key="create-tip-modal.back-to-rules"></span> </button> <div class="mb-3"> <div class="form-text mt-0" data-l10n-key="create-tip-modal.label-tip-text"></div> <textarea class="form-control modalCreateTip_int-text" maxlength="500" required></textarea> <div class="form-text" data-l10n-key="create-tip-modal.label-tip-text-limit"></div> </div> <div class="mb-2"> <div class="form-text mb-1" data-l10n-key="create-tip-modal.label-image"></div> <div class="d-flex flex-column flex-sm-row gap-2 gap-sm-3"> <div> <div class="modalCreateTip_img-container"> <div class="modalCreateTip_img-wrapper"> <button type="button" class="modalCreateTip_btn-img"> <i class="bi bi-card-image"></i> </button> <img class="modalCreateTip_img"> </div> <button type="button" class="modalCreateTip_btn-del-img"> <i class="bi bi-x-lg"></i> </button> </div> </div> <div> <ul class="form-text ps-3 my-1"> <li data-l10n-key="create-tip-modal.image-rule-1"></li> <li data-l10n-key="create-tip-modal.image-rule-2"></li> <li data-l10n-key="create-tip-modal.image-rule-3"></li> </ul> </div> </div> </div> <div> <div class="form-text" data-l10n-key="create-tip-modal.label-units"></div> <div class="select-entities"></div> </div> <hr> <div class="text-end"> <button type="submit" name="action" value="drop_score" class="btn btn-sm btn-warning modalCreateTip_btn-send" data-l10n-key="create-tip-modal.send-to-review"></button> </div> </div> </div> </form> </div> </div> </div>'),t=e.querySelector(".select-entities");this.entitiesSelector=(0,v.T)(t,[],{required:!0}),document.body.appendChild(e),this.bsModal=u.Modal.getOrCreateInstance(e),this.postId=null,this.nodes={modalNode:e,modalTitle:e.querySelector(".modal-title"),inputText:e.querySelector(".modalCreateTip_int-text"),imgNode:e.querySelector(".modalCreateTip_img"),inputImgBtn:e.querySelector(".modalCreateTip_btn-img"),delImgBtn:e.querySelector(".modalCreateTip_btn-del-img"),sendPublishBtn:e.querySelector(".modalCreateTip_btn-send"),sectionRule:e.querySelector(".modalCreateTip_section-rule"),sectionForm:e.querySelector(".modalCreateTip_section-form"),acceptRuleBtn:e.querySelector(".modalCreateTip_btn-rule-accept"),openRuleBtn:e.querySelector(".modalCreateTip_btn-open-rule")};const i=new g.A,n=document.createElement("input");n.type="file",n.accept="image/png, image/jpeg, image/gif",n.onchange=e=>{const t=e.target.files[0],s=this.nodes.inputImgBtn.innerHTML;this.nodes.inputImgBtn.innerHTML=r.A,i.upload(t,this.postId?`p_${this.postId}`:"tip").then((e=>{this.nodes.imgNode.src=e.file.url,this.nodes.imgNode.setAttribute("data-img-uuid",e.file.uuid),this.nodes.imgNode.classList.remove("d-none"),this.nodes.inputImgBtn.classList.add("d-none"),this.nodes.delImgBtn.classList.remove("d-none")})).finally((e=>{n.value="",this.nodes.inputImgBtn.innerHTML=s}))},this.nodes.inputImgBtn.addEventListener("click",(()=>{n.click()})),this.nodes.delImgBtn.addEventListener("click",(()=>{this.nodes.sectionRule.classList.add("d-none"),this.nodes.imgNode.src="",this.nodes.imgNode.removeAttribute("data-img-uuid"),this.nodes.delImgBtn.classList.add("d-none"),this.nodes.inputImgBtn.classList.remove("d-none")})),this.nodes.acceptRuleBtn.addEventListener("click",(()=>{this.nodes.sectionRule.classList.add("d-none"),this.nodes.sectionForm.classList.remove("d-none"),this.nodes.modalNode.scrollTop=0})),this.nodes.openRuleBtn.addEventListener("click",(()=>{this.nodes.sectionRule.classList.remove("d-none"),this.nodes.sectionForm.classList.add("d-none"),this.nodes.modalNode.scrollTop=0})),this.nodes.sendPublishBtn.addEventListener("click",(e=>{e.preventDefault(),this.send()}))}open(e=[]){if(null!==window.app.getLoginUser()){if(this.postId=null,this.nodes.inputText.value="",this.nodes.imgNode.classList.add("d-none"),this.nodes.delImgBtn.classList.add("d-none"),this.nodes.inputImgBtn.classList.remove("d-none"),this.entitiesSelector.clearValues(),e.postId?(this.postId=e.postId,this.nodes.modalTitle.innerText=window.app.l10n("create-tip-modal.title-edit"),this.nodes.sectionRule.classList.add("d-none"),this.nodes.sectionForm.classList.remove("d-none")):(this.nodes.modalTitle.innerText=window.app.l10n("create-tip-modal.title-create"),this.nodes.sectionRule.classList.remove("d-none"),this.nodes.sectionForm.classList.add("d-none")),e.text&&(this.nodes.inputText.value=e.text),e.image&&(this.nodes.imgNode.src=e.image.url,this.nodes.imgNode.setAttribute("data-img-uuid",e.image.uuid),this.nodes.imgNode.classList.remove("d-none"),this.nodes.delImgBtn.classList.remove("d-none"),this.nodes.inputImgBtn.classList.add("d-none")),e.entities){const t=[];e.entities.forEach((e=>{let i=(0,v.Y)(e);null!==i&&t.push(i)})),this.entitiesSelector.items=t,t.forEach((e=>{this.entitiesSelector.setItem(e)}))}this.bsModal.show()}else window.GSEA?.open()}_saveInProgress=!1;send(){if(this._saveInProgress)return;const e=this.nodes.sendPublishBtn.innerHTML;this.nodes.sendPublishBtn.innerHTML=r.A;const t=new FormData;t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),this.postId&&t.append("post_id",this.postId);const i={},n=this.nodes.inputText.value.trim();if(0===n.length)return void window.app.error(window.app.l10n("create-tip-modal.error-empty-text"));i.text=n,this.nodes.imgNode.hasAttribute("data-img-uuid")&&(i.image={uuid:this.nodes.imgNode.getAttribute("data-img-uuid")}),t.append("source",JSON.stringify(i));const a=this.entitiesSelector.getValues();if(0!==a.length)return t.append("entities",a.join(";")||""),this._saveInProgress=!0,(0,s.A)("/api/saveTip",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?(this.postId=e.data.post_id,e.data.review_id?.message?window.app.error(e.data.review_id.message):window.location.href=`/u/ticket/${e.data.review_id}`):window.app.error(e.message)})).finally((t=>{this._saveInProgress=!1,this.nodes.sendPublishBtn.innerHTML=e}));window.app.error(window.app.l10n("create-tip-modal.error-empty-units"))}}class O{constructor(e,t,i){this.gameId=e,this.treeId=t,this.wrapperNode=i,this.compareButton=this.wrapperNode.querySelector("#game-unit_compare"),this.compareButtonLabel=this.compareButton.querySelector("span"),this.removeCompareButton=this.wrapperNode.querySelector("#game-unit_compare-remove");let n=this.getCompareList();this.setInclude(n.includes(this.gameId),n.length),this.compareButton.addEventListener("click",(()=>{let e=this.getCompareList();this.wrapperNode.classList.contains("game-unit_control-group")?window.open("/unit/compare?tree="+this.treeId):e.includes(this.gameId)||(e.length>=20?window.app.warning(window.app.l10n("game-unit.compare-limit")):(e.push(this.gameId),this.saveList(e),window.app.helper.trackEvent("WIKI3_UBTN_COMPARE",{unit_id:this.gameId})))})),this.removeCompareButton.addEventListener("click",(()=>{let e=this.getCompareList();e=e.filter((e=>e!==this.gameId)),this.saveList(e)}))}getCompareList(){let e=window.app.getCookie("unitsCompare"),t=[];try{t=JSON.parse(e)}catch(e){t=[]}return Array.isArray(t)||(t=[]),t}saveList(e){0===e.length?window.app.deleteCookie("unitsCompare"):window.app.setCookie("unitsCompare",JSON.stringify(e)),this.setInclude(e.includes(this.gameId),e.length)}setInclude(e,t){this.wrapperNode.classList.toggle("game-unit_control-group",e),this.removeCompareButton.classList.toggle("d-none",!e),e?this.compareButtonLabel.innerHTML=window.app.l10n("game-unit.button-in-compare")+`<span class="badge bg-primary ms-1">${t}</span>`:this.compareButtonLabel.innerText=window.app.l10n("game-unit.button-compare")}}class D{constructor(e,t,i,n={}){if(this.unitId=e,this.rootNode=t,this.nominationId=t.getAttribute("data-nomination-id"),this.button=t.querySelector(".game-unit_score-button"),i||null===window.app.getLoginUser()?this.button.addEventListener("click",(()=>{null!==window.app.getLoginUser()?this.isProcess||(this.rootNode.hasAttribute("data-score")?this.setScore(0):this.rootNode.classList.toggle("vote-show")):window.GSEA?.open()})):this.button.remove(),t.querySelector(".game-unit_score-vote").addEventListener("click",(e=>{let t=e.target.closest("button");t&&t.hasAttribute("data-score")&&this.setScore(parseInt(t.getAttribute("data-score")))})),"score"in n&&this._setSelectedScore(n.score),"count"in n&&"sum"in n){let e=n.sum/n.count,t=Math.round(e),i=24*(e-1)+4,s=this.rootNode.querySelector(".game-unit_score-line");s.classList.remove("color-empty"),s.classList.add(`color-${t}`),s.style.width=i+"%";let a=this.rootNode.querySelector(".game-unit_score-stat"),o="game-unit.scores-stat-total";"last"===n.period&&(o="game-unit.scores-stat-last"),a.innerText=window.app.l10n(o,{count:n.count})}}isProcess=!1;setScore(e){if(this.isProcess)return;if(null===window.app.getLoginUser())return void window.app.info(window.app.l10n("unauthorized-error.vote"));this.isProcess=!0,this.rootNode.className="game-unit_score";let t=this.button.innerHTML;this.button.innerHTML=r.A;let i=new FormData;return i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("unit_id",this.unitId),i.append("nomination",this.nominationId),i.append("score",e),(0,s.A)("/api/gunitScore",{method:"POST",credentials:"include",body:i}).then((e=>{e.success?this._setSelectedScore(e.data.score):window.app.error(e.message)})).catch((e=>this.button.innerHTML=t)).finally((()=>{this.isProcess=!1}))}_setSelectedScore(e){if(null===e)this.rootNode.removeAttribute("data-score"),this.button.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M342.001-278.616 480-383.924l137.999 105.308-52.153-169.692 137.614-98.307H534.154L480-725.537l-54.154 178.922H256.54l137.614 98.307-52.153 169.692Zm138.066 162.615q-74.836 0-141.204-28.42-66.369-28.42-116.182-78.21-49.814-49.791-78.247-116.129-28.433-66.337-28.433-141.173 0-75.836 28.42-141.704 28.42-65.869 78.21-115.682 49.791-49.814 116.129-78.247 66.337-28.433 141.173-28.433 75.836 0 141.704 28.42 65.869 28.42 115.682 78.21 49.814 49.791 78.247 115.629 28.433 65.837 28.433 141.673 0 74.836-28.42 141.204-28.42 66.369-78.21 116.182-49.791 49.814-115.629 78.247-65.837 28.433-141.673 28.433Z" /></svg>';else{this.rootNode.setAttribute("data-score",e),this.rootNode.classList.add("scored",`score-${e}`);let t=this.rootNode.querySelector(`.game-unit_score-vote button[data-score="${e}"]`);t&&(this.button.innerHTML=t.innerHTML)}}}var V=i(476),z=i(865),j=i(25),G=i(809);class W{static _instance=null;static getOrCreateInstance(){return W._instance||(W._instance=new W),W._instance}constructor(){this.postId=null;let e=$.A.render('<div class="modal fade" id="deleteDraftModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" data-l10n-key="delete-draft-popup.title"></h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body" data-l10n-key="delete-draft-popup.desc"></div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-l10n-key="button_close"></button> <button type="submit" class="btn btn-danger" id="deleteDraftModalBtnDelete" data-l10n-key="button_delete"></button> </div> </div> </div> </div>');document.body.appendChild(e),this.node=e,this.bsModal=u.Modal.getOrCreateInstance(e),this.nodes={btnDelete:e.querySelector("#deleteDraftModalBtnDelete")},this.nodes.btnDelete.addEventListener("click",(()=>{this._send()}))}open(e){e&&(this.postId=e,this.bsModal.show())}_isSending=!1;_send(){if(!this.postId)return;if(this._isSending)return;this._isSending=!0;let e=this.nodes.btnDelete.innerText;this.nodes.btnDelete.innerHTML=r.A,this.nodes.btnDelete.disabled=!0;var t=new FormData;t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("postId",this.postId),(0,s.A)("/api/deleteDraft",{method:"POST",credentials:"include",body:t}).then((e=>{if(e?.success){let e=document.querySelector(`.feed__item[data-feed-pid="${this.postId}"]`);e?e.remove():window.location.href="/"}else window.app.error(e.message)})).finally((()=>{this.nodes.btnDelete.innerText=e,this.nodes.btnDelete.disabled=!1,this._isSending=!1,this.bsModal.hide()}))}}class J{static _instance=null;static getOrCreateInstance(){return J._instance||(J._instance=new J),J._instance}constructor(){let e=$.A.render('<div class="modal fade" id="commentRuleModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" data-l10n-key="comment-rule-popup.title"></h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p class="mb-2 fw-bold" data-l10n-key="comment-rule-popup.row-1"></p> <p class="mb-2" data-l10n-key="comment-rule-popup.row-2"></p> <table class="ms-1 mb-2 border-0"> <tr> <td class="text-success" style="font-size:1.25em;vertical-align:top"><i class="bi bi-check-circle-fill me-3"></i></td> <td class="pb-1" data-l10n-key="comment-rule-popup.row-3"></td> </tr> <tr> <td class="text-success" style="font-size:1.25em;vertical-align:top"><i class="bi bi-check-circle-fill me-3"></i></td> <td class="pb-1" data-l10n-key="comment-rule-popup.row-4"></td> </tr> <tr> <td class="text-danger" style="font-size:1.25em;vertical-align:top"><i class="bi bi-x-circle-fill me-3"></i></td> <td data-l10n-key="comment-rule-popup.row-5"></td> </tr> </table> <p class="mb-2" data-l10n-key="comment-rule-popup.row-6"></p> <a href="#" target="_blank" data-l10n-key="comment-rule-popup.link"></a> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-l10n-key="button_close"></button> </div> </div> </div> </div>');document.body.appendChild(e),this.node=e,this.bsModal=u.Modal.getOrCreateInstance(e)}open(){this.bsModal.show()}}var Z=i(59),X=i(649),Q=i(503);class Y{static init(){const e=document.querySelectorAll(".info-block-place");Y._fillInfoBlocks(e),window.addEventListener("resize",(function(){Y._fillInfoBlocks(e)}))}static _fillInfoBlocks(e){let t=[];e.forEach((e=>{e.classList.contains("js-loaded")||"none"!==window.getComputedStyle(e,null).display&&t.push(e)}));let i=[];if(t.forEach((e=>{i.push({placeId:e.getAttribute("data-place-id"),tags:e.getAttribute("data-place-tags")})})),0===i.length)return;const n=new FormData;n.append(window.app.getCSRFParam(),window.app.getCSRFToken()),n.append("json",JSON.stringify(i)),(0,s.A)("/api/getInfoBlocks",{method:"POST",credentials:"include",body:n}).finally((e=>{t.forEach((e=>{e.classList.add("js-loaded"),e.innerHTML=""}))})).then((e=>{e?.success?(e.data||[]).forEach((e=>{const i=e.placeId,n=t.find((e=>e.getAttribute("data-place-id")===i));if(n){const t=e.nodes.join("");n.innerHTML=t}})):window.app.error(e.message)}))}}class K{static _instance=null;static getOrCreateInstance(){return K._instance||(K._instance=new K),K._instance}constructor(){const e=$.A.render('<div class="modal fade gsearch" id="searchModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-body"> <div class="gsearch-input-wrapper"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="gsearch-input-icon" viewBox="0 0 16 16"> <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/> </svg> <input class="gsearch-input" name="q" type="text" autocomplete="off" maxlength="50"> <div class="gsearch-controls"> <div class="gsearch-control gsearch-spinner d-none"> <div class="spinner-border spinner-border-sm" role="status"> <span class="visually-hidden"></span> </div> </div> <button class="gsearch-control gsearch-btn-clear d-none" type="button"> <i class="bi bi-x-lg"></i> </button> </div> </div> <hr> <div class="gsearch-results"></div> </div> </div> </div> </div>');document.body.appendChild(e),this.node=e,this.bsModal=u.Modal.getOrCreateInstance(e),this.initPopup(this.node)}open(){this.bsModal.show()}initPopup(e){this.popupNodes={inputWrapper:e.querySelector(".gsearch-input-wrapper"),inputField:e.querySelector(".gsearch-input"),spinner:e.querySelector(".gsearch-spinner"),btnClear:e.querySelector(".gsearch-btn-clear"),resultsRoot:e.querySelector(".gsearch-results")},this.popupNodes.inputField.placeholder=window.app.l10n("global-search.placeholder"),this.popupNodes.inputField.addEventListener("focus",(()=>{this.popupNodes.inputWrapper.classList.add("focus")})),this.popupNodes.inputField.addEventListener("blur",(()=>{this.popupNodes.inputWrapper.classList.remove("focus")})),this.searchTimer=void 0,this.popupNodes.inputField.addEventListener("input",(()=>{this.popupNodes.spinner.classList.remove("d-none"),this.popupNodes.resultsRoot.classList.add("opacity-50"),void 0!==this.searchTimer&&clearTimeout(this.searchTimer),this.searchTimer=setTimeout((()=>{this.searchTimer=void 0;let e=this.popupNodes.inputField.value.trim();""!==e?(this.popupNodes.btnClear.classList.remove("d-none"),this.search(e).finally((e=>{this.popupNodes.spinner.classList.add("d-none")}))):(this.popupNodes.btnClear.classList.add("d-none"),this.popupNodes.spinner.classList.add("d-none"),this.renderResentSearch()),this.popupNodes.resultsRoot.classList.remove("opacity-50")}),1e3)})),this.popupNodes.btnClear.addEventListener("click",(()=>{this.popupNodes.inputField.value="",this.popupNodes.btnClear.classList.add("d-none"),this.renderResentSearch()})),e.addEventListener("show.bs.modal",(()=>{this.popupNodes.inputField.value="",this.popupNodes.spinner.classList.add("d-none"),this.popupNodes.btnClear.classList.add("d-none"),this.renderResentSearch()})),e.addEventListener("shown.bs.modal",(()=>{this.popupNodes.inputField.focus()}))}_inProgress=!1;search(e){if(this._inProgress)return;this._inProgress=!0;const t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("q",e),(0,s.A)("/api/search",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?0===e.result.length?this.renderEmptySearchMsg():this.renderResults(e.result):(this.renderEmptySearchMsg(),window.app.error(e.message))})).catch((e=>this.renderEmptySearchMsg())).finally((e=>{this._inProgress=!1}))}renderResults(e){this.popupNodes.resultsRoot.innerHTML="",e.forEach((e=>{if(!e.items||0===e.items.length)return;const t=document.createElement("div");if(t.className="gsearch-results-group",e.title){const i=document.createElement("div");i.className="gsearch-results-header",i.innerText=e.title,t.appendChild(i)}const i=document.createElement("div");i.className="gsearch-results-list",e.items.forEach((e=>{const t=document.createElement("a");t.className="gsearch-result",t.href=e.link;const n=document.createElement("div");n.className="gsearch-result_icon",n.innerHTML=e?.icon||"";const s=document.createElement("div");s.className="gsearch-result_title",s.innerText=e.title;const a=document.createElement("div");a.className="gsearch-result_subtitle",a.innerText=e?.subtitle||"";const o=document.createElement("div");o.className="gsearch-result_content",o.appendChild(s),o.appendChild(a),t.appendChild(n),t.appendChild(o),t.addEventListener("click",(()=>{this.addRecentSuccessSearch(e)})),t.addEventListener("auxclick",(t=>{1===t.button&&this.addRecentSuccessSearch(e)})),i.appendChild(t)})),t.appendChild(i),this.popupNodes.resultsRoot.appendChild(t)}))}renderEmptySearchMsg(){this.renderMessage(window.app.l10n("global-search.nothing-found"))}renderResentSearch(){const e=this.getRecentSuccessSearch();null===e?this.renderEmptyResentSearchMsg():this.renderResults([{title:window.app.l10n("global-search.last-search"),items:e}])}renderEmptyResentSearchMsg(){this.renderMessage(window.app.l10n("global-search.empty-last-search"))}getRecentSuccessSearch(){try{const e=localStorage.getItem("searchRecentItems");return null===e?null:JSON.parse(e)}catch(e){return console.error(e),null}}addRecentSuccessSearch(e){let t=this.getRecentSuccessSearch();return null===t?(localStorage.setItem("searchRecentItems",JSON.stringify([e])),!0):(t=t.filter((t=>t.link!==e.link)),t.unshift(e),localStorage.setItem("searchRecentItems",JSON.stringify(t.slice(0,6))),!0)}renderMessage(e){this.popupNodes.resultsRoot.innerHTML="";const t=document.createElement("div");t.className="text-center p-3",t.innerText=e,this.popupNodes.resultsRoot.appendChild(t)}}var ee={main:class{constructor(){var e=document.getElementById("feed");null!==e&&(this.feed=d.init(e)),this.swiper=null,window.addEventListener("resize",(()=>{this._updateMainButtons()})),this._updateMainButtons()}_updateMainButtons(){let e=parseInt(window.getComputedStyle(document.body).getPropertyValue("--bs-breakpoint-sm"));window.innerWidth<e?this.swiper?this.swiper.enable():window.app.loadModule("swiper").then((({default:e})=>{this.swiper=new e.Swiper(".main-button.swiper",{slidesPerView:"auto",spaceBetween:8,centeredSlides:!0,loop:!0,autoplay:{delay:3e3,disableOnInteraction:!1},pagination:{el:".swiper-pagination",clickable:!0}})})):this.swiper&&this.swiper.disable()}},category:class{constructor(){this.categoryCard=document.querySelector(".category-card"),this.categoryId=Number(this.categoryCard.getAttribute("data-category-id"));let e=document.getElementById("feed");null!==e&&(this.feed=d.init(e)),this.categoryCard.querySelector(".tag-subscribe")?.addEventListener("click",(()=>{this.subscribe(0)})),this.categoryCard.querySelector(".tag-unsubscribe")?.addEventListener("click",(()=>{this.subscribe(-1)})),this.categoryCard.querySelector(".tag-ignore")?.addEventListener("click",(()=>{this.subscribe(1)})),this.categoryCard.querySelector(".tag-unignore")?.addEventListener("click",(()=>{this.subscribe(-1)}))}_inProcess=!1;async subscribe(e){if(!this._inProcess){if(null!==window.app.getLoginUser()){this._inProcess=!0;var t=new FormData;return t.append("category_id",this.categoryId),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("type",e),(0,s.A)("/api/categorySubscribe",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)switch(this.categoryCard.classList.remove("subscribed"),this.categoryCard.classList.remove("ignored"),e.data.subscribe){case 0:this.categoryCard.classList.add("subscribed");break;case 1:this.categoryCard.classList.add("ignored")}else window.app.error(e.message)})).finally((()=>{this._inProcess=!1}))}window.app.info(window.app.l10n("unauthorized-error.subscribe"))}}},page:class{constructor(){c.init()}},post:class{constructor(){c.init();const e=document.getElementById("post");this.post_root=e,this.post_id=Number(e.getAttribute("data-post-id")),null!==window.app.getLoginUser()&&(this.voteManager=new o(this.post_id),this.bookmarkManager=new a(this.post_id));const t=e.querySelector(".post-like");this.voteButton=t,t&&t.addEventListener("click",(()=>{this.post_root.classList.contains("post--liked")?this.vote(null):this.vote(!0)})),e.querySelectorAll(".post-bookmark").forEach((t=>{t.addEventListener("click",(()=>{e.classList.contains("post--with-bookmark")?this.bookmark(!1):this.bookmark(!0)}))})),e.querySelectorAll(".post-share").forEach((e=>{navigator.share?e.addEventListener("click",(()=>{navigator.share({url:window.location.href,title:document.title})})):e.style.display="none"}));var i=document.getElementById("comments");i&&(this.comments=new p(this.post_id,i));let n=document.getElementById("modal-report-typo");if(n){let t=n.querySelector("pre"),i=n.querySelector("textarea"),a=n.querySelector("#modalBtnSendReportTypo"),o=u.Modal.getOrCreateInstance(n);document.addEventListener("keydown",(n=>{if((n.ctrlKey||n.metaKey)&&"Enter"===n.key){let n=document.getSelection();if(!n||n.isCollapsed||!e.contains(n.anchorNode))return;let s=n.toString().trim().slice(0,500);if(0===s.length)return;i.value="",t.innerText=s,o.show()}}));let l=!1;a.addEventListener("click",(()=>{if(l)return;let e=t.innerText.trim();if(0===e.length)return void window.app.error(window.app.l10n("report-popup.error-empty-fragment"));let n=i.value.trim();var d=new FormData;d.append(window.app.getCSRFParam(),window.app.getCSRFToken()),d.append("post_id",this.post_id),d.append("fragment",e),0!==n.length&&d.append("comment",n),l=!0;let c=a.innerText;a.disabled=!0,a.innerHTML=r.A,(0,s.A)("/api/reportTypo",{method:"POST",credentials:"include",body:d}).then((e=>{e.success?(window.app.success(window.app.l10n("report-popup.send")),o.hide()):window.app.error(e.message)})).finally((e=>{l=!1,a.innerText=c,a.disabled=!1}))}))}let l=document.getElementById("post_feed");if(l){this.feed=d.init(l);let e=document.getElementById("post_feed-nav");e&&e.addEventListener("click",(t=>{let i=t.target.closest("[data-feed-sort]");if(i){let t=i.getAttribute("data-feed-sort");this.feed.atributes.sort=t,e.querySelectorAll(".active[data-feed-sort]").forEach((e=>{e.classList.remove("active")})),i.classList.add("active"),this.feed.refresh()}}))}}_isVoteProcessed=!1;vote(e){this._isVoteProcessed||(null!==window.app.getLoginUser()?(this._isVoteProcessed=!0,this.voteManager.vote(e).then((e=>{const t=this.voteButton.querySelector(".value");1===e.data.vote?this.post_root.classList.add("post--liked"):this.post_root.classList.remove("post--liked");const i=window.app.getLang();t&&(null!==e.data.rating?t.innerText=new Intl.NumberFormat(i).format(e.data.rating):t.innerText="")})).catch((e=>{window.app.error(e.message)})).finally((e=>{this._isVoteProcessed=!1}))):window.app.info(window.app.l10n("unauthorized-error.vote")))}bookmarkSend=!1;bookmark(e){this.bookmarkSend||(null!==window.app.getLoginUser()?(this.bookmarkSend=!0,this.bookmarkManager.bookmark(e).then((e=>{this.post_root.classList.toggle("post--with-bookmark",e.data.bookmark);var t=window.app.getLang();this.post_root.querySelectorAll(".post-bookmark .value").forEach((i=>{i.innerText=new Intl.NumberFormat(t).format(e.data.count)})),this.bookmarkSend=!1})).catch((e=>{window.app.error(e.message),this.bookmarkSend=!1}))):window.app.info(window.app.l10n("unauthorized-error.bookmark")))}},user:class{constructor(){var e=document.getElementById("user-profile");this.user_root=e,this.user_id=Number(e.getAttribute("data-user-id"));var t=document.getElementById("feed");null!==t&&(this.feed=d.init(t)),document.querySelector(".user-subscribe")?.addEventListener("click",(()=>{this.subscribe(0)})),document.querySelector(".user-unsubscribe")?.addEventListener("click",(()=>{this.subscribe(-1)})),document.querySelector(".user-ignore")?.addEventListener("click",(()=>{this.subscribe(1)})),document.querySelector(".user-unignore")?.addEventListener("click",(()=>{this.subscribe(-1)}))}_inProcess=!1;async subscribe(e){if(!this._inProcess){if(null!==window.app.getLoginUser()){this._inProcess=!0;var t=new FormData;return t.append("user_id",this.user_id),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("type",e),(0,s.A)("/api/userSubscribe",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)switch(this.user_root.classList.remove("user-profile--subscribed"),this.user_root.classList.remove("user-profile--ignored"),e.data.subscribe){case 0:this.user_root.classList.add("user-profile--subscribed");break;case 1:this.user_root.classList.add("user-profile--ignored")}else window.app.error(e.message)})).finally((()=>{this._inProcess=!1}))}window.app.info(window.app.l10n("unauthorized-error.subscribe"))}}},"user-profile-setting":class{constructor(){var e=document.getElementById("user-profile__avatar-input");if(null!==e){var t=document.createElement("input");t.type="file",t.accept="image/png, image/jpeg, image/gif, image/webp",t.onchange=e=>{var t=e.target.files[0];this.uploadAvatar(t)},e.addEventListener("click",(()=>{t.click()}))}}uploadAvatar(e){var t=new FormData;return t.append("image_file",e),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),(0,s.A)("/api/avatar",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?document.querySelector(".user-profile__avatar img").src=e.data.url:window.app.error(e.message)}))}},editor:class{constructor(){var e=document.getElementById(f).value,t={};""!==e&&(t=JSON.parse(e)),this.timer=void 0,this.post_id=t.post_id||null,this.version_id=t.version_id||null,this.title_input=document.getElementById(y),this.title_input.value=t.title||null,this.title_input.oninput=()=>{this.autosave()};let i=t.source?JSON.parse(t.source):null;this.imageUploader=new g.A;let n="";if(0==this.title_input.value.trim().length&&null==i){let e=window.app.l10n("editor.random-placeholder");if(Array.isArray(e)&&e.length>0){let t=e[Math.floor(Math.random()*e.length)];this.title_input.setAttribute("placeholder",t[0]),n=t[1]}else n=window.app.l10n("editor.body-placeholder")}else n=window.app.l10n("editor.body-placeholder");let s=window.app.l10n("editorMessages");s||(s={}),window.app.loadModule("editor").then((async({default:e})=>{var t=async(e,t)=>{if(null===this.post_id&&await this.save("autosave"),"file"===t)return this.imageUploader.upload(e,`p_${this.post_id}`)};const a=await window.app.loadModule("sortable").then((({default:e})=>e.Sortable));this.editorjs=new e.EditorJS({holder:_,placeholder:n,onChange:()=>{this.autosave()},data:i,tools:{header:{class:e.Header,config:{levels:[2,3,4],defaultLevel:2}},list:{class:e.List,inlineToolbar:!0,config:{defaultStyle:"unordered"}},quote:{class:e.QuoteAdvanced,inlineToolbar:!0,config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp"}},image:{class:e.ImageTool,inlineToolbar:["link"],config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp",features:{border:!1}}},gallery:{class:e.ImageGallery,inlineToolbar:["link"],maxElementCount:9,config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp",sortableJs:a}},embed:{class:e.Embed,inlineToolbar:!0},table:{class:e.Table,inlineToolbar:!0,config:{rows:2,cols:3}},delimiter:e.Delimiter,spoiler:{class:e.Spoiler,config:{editorLibrary:e.EditorJS,editorTools:{header:{class:e.Header,config:{levels:[3,4],defaultLevel:3}},list:{class:e.List,inlineToolbar:!0,config:{defaultStyle:"unordered"}},quote:{class:e.QuoteAdvanced,inlineToolbar:!0,config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp"}},image:{class:e.ImageTool,inlineToolbar:["link"],config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp",features:{border:!1,stretch:!1}}},embed:{class:e.Embed,inlineToolbar:!0},table:{class:e.Table,inlineToolbar:!0,config:{rows:2,cols:3}},delimiter:e.Delimiter,code:e.CodeTool,anchorTune:e.AnchorTune,backgroundTune:e.BackgroundTune,marker:e.Marker,inlineCode:e.InlineCode,annotation:e.Annotation},editorTunes:["anchorTune","backgroundTune"]}},multicolumn:{class:e.Multicolumn,config:{editorLibrary:e.EditorJS,editorTools:{header:{class:e.Header,config:{levels:[3,4],defaultLevel:3}},list:{class:e.List,inlineToolbar:!0,config:{defaultStyle:"unordered"}},image:{class:e.ImageTool,inlineToolbar:["link"],config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp",features:{border:!1,stretch:!1}}},table:{class:e.Table,inlineToolbar:!0,config:{rows:2,cols:3}},delimiter:e.Delimiter,code:e.CodeTool,anchorTune:e.AnchorTune,backgroundTune:e.BackgroundTune,marker:e.Marker,inlineCode:e.InlineCode,annotation:e.Annotation},editorTunes:["anchorTune","backgroundTune"]}},code:e.CodeTool,marker:e.Marker,inlineCode:e.InlineCode,annotation:e.Annotation,anchorTune:e.AnchorTune,backgroundTune:e.BackgroundTune},tunes:["anchorTune","backgroundTune"],i18n:{messages:s},onReady:()=>{document.getElementById("wiki-editor-preloader").classList.add("hide");const t=new e.Undo({editor:this.editorjs});null!==i&&t.initialize(i)}}),this.typograf=e.createTypograf(),this.btnTypograf=document.getElementById(C),this.btnTypograf.addEventListener("click",(()=>{this.runTypograf()}))}));let a=[];t.categories&&t.categories.forEach((e=>{a.push({value:e.tag,badgeHTML:e.title})})),this.categoriesSelector=(0,w.i)(document.getElementById(L),a,(()=>{this.autosave()}));let o=[];t.entities&&t.entities.forEach((e=>{let t=(0,v.Y)(e);null!==t&&o.push(t)})),this.entitiesSelector=(0,v.T)(document.getElementById(S),o,{onChange:()=>{this.autosave()}}),document.addEventListener("click",(e=>{var t=e.target.closest("button");if(t)switch(t.id){case T:this.save("save");break;case k:this.save("preview");break;case q:this.openHistory()}}));let l=document.getElementById(B);if(l){let e=document.getElementById(E);if(e){e.addEventListener("click",(()=>{let t=e.innerText;e.innerHTML=r.A,e.disabled=!0,this.save("review").finally((i=>{e.innerText=t,e.disabled=!1}))}));let t=document.getElementById(P),i=document.getElementById(F),n=document.getElementById(N),s=document.getElementById(R);l.addEventListener("show.bs.modal",(()=>{let a=!1,o=!1,r=0,l=this.editorjs.blocks.getBlocksCount();for(let e=0;e<l;e++){let t=this.editorjs.blocks.getBlockByIndex(e);t&&!t.isEmpty&&(t.holder.querySelector("img.image-tool__image-picture")||t.holder.querySelector("img.image-gallery__image-picture")||t.holder.querySelector(".embed-tool__content")?o=!0:r+=t.holder.innerText.length)}r>500&&(a=!0);let d=this.categoriesSelector.getValues().length>0||this.entitiesSelector.getValues().length>0;if(a&&o&&d)t.classList.add("d-none"),e.classList.remove("d-none");else{t.classList.remove("d-none"),e.classList.add("d-none");let r=(e,t)=>{e.innerHTML=t?'<i class="bi bi-check-circle-fill text-success"></i>':'<i class="bi bi-x-circle-fill text-danger"></i>'};r(i,a),r(n,o),r(s,d)}}))}}}_saveInProgress=!1;async save(e){if(!this._saveInProgress){this._saveInProgress=!0;var t=await this.editorjs.save().then((e=>JSON.stringify(e))),i=this.categoriesSelector.getValues().join(";"),n=this.entitiesSelector.getValues().join(";"),a=document.getElementById(I),o=document.getElementById(A),r=document.getElementById(M),l=new FormData;switch(l.append(window.app.getCSRFParam(),window.app.getCSRFToken()),l.append("post_id",this.post_id||""),l.append("title",this.title_input.value.trim()||""),l.append("source",t||""),l.append("categories",i||""),l.append("entities",n||""),e){case"autosave":case"review":l.append("event",e);break;default:l.append("event","save")}return clearTimeout(this.timer),this.timer=void 0,a.classList.remove("d-none"),o.classList.add("d-none"),(0,s.A)("/api/save",{method:"POST",credentials:"include",body:l}).then((t=>{if(t.success){window.onbeforeunload=null,null===this.post_id&&(this.post_id=t.data.post_id,window.history.pushState({post_id:this.post_id},"",`/editor/${this.post_id}`));var i=new Date,n=i.getHours().toString().padStart(2,"0"),s=i.getMinutes().toString().padStart(2,"0");r.innerText=`${n}:${s}`,o.classList.remove("d-none");const l=t.data.version_id??null,d=t.data.prev_version_id??null;switch(null!==this.version_id&&null!==d&&this.version_id!==d&&window.app.warning(window.app.l10n("editor.warning-parallel-editing")),this.version_id=l,e){case"preview":var a="/"+this.post_id;void 0!==t.data.version_id&&(a+="/"+t.data.version_id),window.open(a,"_blank").focus();break;case"review":if(!t.data.review){window.app.error(window.app.l10n("editor.error-create-ticket"));break}if(!t.data.review.success){window.app.error(t.data.review.message);break}window.location.href=`/u/ticket/${t.data.review.data.ticket_id}`}}else window.app.error(t.message)})).finally((e=>{a.classList.add("d-none"),this._saveInProgress=!1}))}}autosave(){void 0===this.timer&&(this.timer=setTimeout((()=>{this.save("autosave")}),3e5),window.onbeforeunload=()=>!0)}openHistory(){if(null!==this.post_id){var e=document.getElementById(x);if(null!==e){var t=u.Modal.getOrCreateInstance(e);t.show();var i=`${x}--empty`;if(e.classList.contains(i)){var n=new URL("/api/getPostHistory",window.location.origin);n.searchParams.set("post_id",this.post_id),(0,s.A)(n,{credentials:"include"}).then((t=>{var n=e.querySelector(".modal-body");if(n.innerHTML="",t.hasOwnProperty("versions")&&0!=t.versions.length)for(var s in t.versions){var a=document.createElement("div");a.className="versions";var o=document.createElement("div");o.className="versions__date",o.textContent=s;var r=document.createElement("div");r.className="versions__container",t.versions[s].forEach((e=>{var t=document.createElement("a"),i=new Date(1e3*e.create),n=`${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}`;t.innerHTML="",e.hasOwnProperty("current")&&(t.innerHTML+='<i class="bi bi-star-fill"></i>'),this.version_id===e.id&&(t.innerHTML+='<i class="bi bi-eye"></i>'),t.innerHTML+=n,t.href=`/${this.post_id}/${e.id}`,t.target="_blank",r.append(t)})),a.append(o),a.append(r),n.append(a)}else n.textContent=window.app.l10n("editor.history-empty");e.classList.remove(i)})).catch((e=>{t.hide(),window.app.error(window.app.l10n("editor.error-load-history"))}))}}}}_ignoreBlockType=["code","delimiter"];_isTypografRun=!1;async runTypograf(){if(!this.editorjs||!this.typograf||this._isTypografRun)return;this._isTypografRun=!0;let e=this.btnTypograf.innerHTML;this.btnTypograf.innerHTML=r.A,await this.save();let t=this.editorjs.blocks.getBlocksCount();for(let e=0;e<t;e++){const t=this.editorjs.blocks.getBlockByIndex(e);this._ignoreBlockType.includes(t.name)||t.holder.querySelectorAll("[contenteditable], .cdx-input").forEach((e=>{e.classList.contains("ce-code__textarea")||e.classList.contains("ce-rawtool__textarea")||(e.value?e.value=this.typograf.execute(e.value):e.innerHTML=this.typograf.execute(e.innerHTML))}))}this.btnTypograf.innerHTML=e,this._isTypografRun=!1}},"game-unit":class{constructor(){const e=document.querySelector(".game-unit");if(!e)return;this.rootNode=e;let t=document.getElementById("game-unit-initial"),i=JSON.parse(t.value);this.unitId=i.id,this.gameId=i.gameId,this.treeId=i.treeId,i.isFavorite&&this.rootNode.classList.add("game-unit--favorite"),this._setFavoriteCounter(i.favoriteCount),e.querySelector(".game-unit_cover-item")&&window.app.loadModule("photoswipe").then((({default:e})=>{const t=new e.PhotoSwipeLightbox({gallery:".game-unit_card",children:".game-unit_cover-item",thumbSelector:".game-unit_cover-item",hideAnimationDuration:0,pswpModule:e.PhotoSwipe});t.on("uiRegister",(function(){t.pswp.ui.registerElement(e.downloadButtonConfig)})),t.init()}));const n=document.getElementById("game-unit_share");n&&(navigator.share?n.addEventListener("click",(()=>{const e={title:document.title,text:window.app.getMetaByName("description"),url:window.location.origin+window.location.pathname};navigator.share(e)})):n.remove());const s=e.querySelector(".game-unit_compare-wrapper");s&&new O(this.gameId,this.treeId,s);const a=document.getElementById("game-unit_cockpit");a&&a.addEventListener("click",(()=>{this.openCockpitPopup(a.getAttribute("data-image-url"))}));const o=document.getElementById("game-unit_game-view");o&&o.addEventListener("click",(()=>{this.showUnit()})),this.showInGameButton=o;const r=document.getElementById("game-unit_game-view-help");if(r.addEventListener("click",(()=>{this.openShowUnitGuestModal()})),this.showInGameHelpButton=r,e.querySelectorAll(".game-unit_favorite-button").forEach((t=>{t.addEventListener("click",(()=>{e.classList.contains("game-unit--favorite")?this.setFavorite(!1):this.setFavorite(!0)}))})),e.querySelectorAll(".game-unit_score").forEach((e=>{if(!e.hasAttribute("data-nomination-id"))return;let t=e.getAttribute("data-nomination-id");new D(this.unitId,e,i.canVote,i.scores[t]??{})})),!i.canVote&&null!==window.app.getLoginUser()){const t=e.querySelector("#user-score-alert");t?.classList.remove("d-none")}const l=e.querySelector(".game-unit_mods .accordion-collapse");if(l){let t=e.querySelector(".game-unit_mods");l.addEventListener("shown.bs.collapse",(()=>{if(t.classList.contains("js-loaded"))return;let e=t.querySelector(".game-unit_mods-wrapper"),i=t.querySelector(".game-unit_mods-canvas");i.width=e.clientWidth,i.height=e.clientHeight;let n=new H(e,i,{arrowPadding:-4.5,arrowThickness:5});n.getCtx().fillStyle="#607D8B",e.querySelectorAll("[data-mod-req-id]").forEach((t=>{let i=t.getAttribute("data-mod-req-id"),s=e.querySelector(`[data-mod-id="${i}"]`);n.draw(s,t)})),t.classList.add("js-loaded")}))}let d=null;document.addEventListener("click",(e=>{if(d){if(d.tip.contains(e.target)||d._element.contains(e.target))return;d.hide(),d=null}let t=e.target.closest("[data-feature-popover]");if(t){let e=u.Popover.getInstance(t);if(!e){let i=document.createElement("div");i.innerHTML=t.getAttribute("data-feature-popover");const n=i.querySelector('.penetration-info[data-bs-toggle="popover"]');n&&u.Popover.getOrCreateInstance(n,{customClass:"game-unit_popover shadow",html:!0,sanitize:!1,trigger:"focus",placement:"right"}),e=u.Popover.getOrCreateInstance(t,{customClass:"game-unit_popover shadow",content:i,html:!0,trigger:"manual",placement:"bottom"})}e.show(),d=e}})),document.getElementById("btnModeRealistic").addEventListener("click",(()=>{e.classList.remove("cur-char-ab"),e.classList.add("cur-char-rb")})),document.getElementById("btnModeArcade").addEventListener("click",(()=>{e.classList.remove("cur-char-rb"),e.classList.add("cur-char-ab")}));let c=document.getElementById("btnUnitTop"),m=document.getElementById("btnUnitBasic");c&&m&&(c.addEventListener("click",(()=>{e.classList.remove("cur-mod-basic"),e.classList.add("cur-mod-ref")})),m.addEventListener("click",(()=>{e.classList.remove("cur-mod-ref"),e.classList.add("cur-mod-basic")})));const h=document.getElementById("game-unit_feed");h&&(this.feed=this._initFeedNode(h));const p=document.getElementById("game-unit_create-tip-btn");p&&p.addEventListener("click",(()=>{const e=p.getAttribute("data-init-entitie"),t=JSON.parse(e);this.openCreateTipModal(t.entities)}));const g=document.getElementById("game-unit_tips");g&&new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(this.loadTips(g),t.unobserve(e.target))}))}),{threshold:.5}).observe(g),window.app.helper.yaMetrika("params",{unit_id:this.gameId,tree_id:this.treeId})}_initFeedNode(e){const t=d.init(e),i=document.getElementById("game-unit_feed-nav");i&&i.addEventListener("click",(e=>{const n=e.target.closest("[data-feed-section]");if(n){const e=n.getAttribute("data-feed-section");t.atributes.section=e,i.querySelectorAll(".active[data-feed-section]").forEach((e=>{e.classList.remove("active")})),n.classList.add("active"),t.refresh()}}));const n=document.getElementById("game-unit_feed-sort");return n&&n.addEventListener("click",(e=>{const i=e.target.closest("[data-feed-sort]");if(i){const e=i.getAttribute("data-feed-sort");t.atributes.sort=e,n.querySelectorAll(".active[data-feed-sort]").forEach((e=>{e.classList.remove("active")})),i.classList.add("active"),t.refresh()}})),t}openCockpitPopup(e){window.app.loadModule("pannellum").then((({default:t})=>{let i=document.getElementById("cockpit-popup");if(!i){i=document.createElement("div"),i.id="cockpit-popup",i.classList.add("modal","fade","cockpit-popup"),i.setAttribute("aria-hidden","true");let t=document.createElement("div");t.classList.add("modal-dialog");let n=document.createElement("div");n.classList.add("modal-content"),t.appendChild(n),i.appendChild(t),document.body.appendChild(i);let s=window.pannellum.viewer(n,{type:"equirectangular",panorama:e,autoLoad:!0,strings:window.app.l10n("pannellum")});i.addEventListener("shown.bs.modal",(()=>{s.resize()}))}u.Modal.getOrCreateInstance(i).show(),window.app.helper.trackEvent("WIKI3_UBTN_COCKPIT",{unit_id:this.gameId})}))}openShowUnitGuestModal(){if(!this.unitViewGuestModal){let e=$.A.render('<div class="modal fade" id="gameUnitViewForGuestModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <style>@keyframes gameUnitViewForGuestModal_btn-animation{from{margin-left:0}to{margin-left:-100%}}.gameUnitViewForGuestModal_btn-register{position:relative;display:flex;align-items:center;justify-content:center;background-color:#e44844;color:#eee;padding:8px 10px 9px;transition:.2s;font-size:22px;text-align:center;border-radius:3px;width:100%;text-decoration:none;margin-top:10px;font-family:WTFont,Roboto,sans-serif;text-shadow:1px 1px 0 #000;transition:.5s;overflow:hidden}.gameUnitViewForGuestModal_btn-register_bg{position:absolute;left:0;top:0;width:240%;height:100%;background:repeating-linear-gradient(-45deg,#d30808,#d30808 2%,#aa0505 0,#aa0505 4%)}.gameUnitViewForGuestModal_btn-register:hover{background-color:red;box-shadow:0 0 17px 5px rgba(255,37,17,.5)}.gameUnitViewForGuestModal_btn-register:hover .gameUnitViewForGuestModal_btn-register_bg{animation:gameUnitViewForGuestModal_btn-animation 10s linear infinite;background:repeating-linear-gradient(-45deg,#e70808,#e70808 2%,#b70606 0,#b70606 4%)}</style> <div class="modal-dialog" style="max-width:400px"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" data-l10n-key="game-unit_view-guest-popup.header"></h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <form class="modal-form"> <div class="modal-body" style="font-size:1.1em"> <b class="mb-1" data-l10n-key="game-unit_view-guest-popup.player-header"></b> <ol> <li data-l10n-key="game-unit_view-guest-popup.player-row-1"></li> <li data-l10n-key="game-unit_view-guest-popup.player-row-2"></li> <li data-l10n-key="game-unit_view-guest-popup.player-row-3"></li> </ol> <hr> <b data-l10n-key="game-unit_view-guest-popup.guest-header"></b> <div data-l10n-key="game-unit_view-guest-popup.guest-row-1"></div> <a href="#" target="_blank" class="gameUnitViewForGuestModal_btn-register" onclick=\'app.helper.trackEvent("WIKI3_UBTN_GSHOW_REG")\'> <div class="gameUnitViewForGuestModal_btn-register_bg"></div> <span style="z-index:1" data-l10n-key="game-unit_view-guest-popup.register-button"></span> </a> </div> </form> </div> </div> </div>');e.querySelector(".gameUnitViewForGuestModal_btn-register").href=this.showInGameHelpButton.getAttribute("data-register-link"),document.body.appendChild(e),this.unitViewGuestModal=u.Modal.getOrCreateInstance(e)}this.unitViewGuestModal.show()}_tipsData=[];loadTips(e){const t=e.querySelector(".game-unit_tips-list");if(!t)return;if(t.classList.contains("js-loaded"))return;t.innerHTML="";const i=e.querySelector(".game-unit_tips-preloader"),n=e.querySelector(".game-unit_tips-empty"),a=new FormData;return a.append(window.app.getCSRFParam(),window.app.getCSRFToken()),a.append("unit_id",this.unitId),(0,s.A)("/api/gunitLoadTips",{method:"POST",body:a}).then((e=>{e.success?e?.data?.items?.length?(this._tipsData=e.data.items,e.data.items.forEach(((e,i)=>{const n=document.createElement("a");n.href=e.url,n.target="_blank",n.className="game-unit_tip";const s=document.createElement("div");if(s.className="game-unit_tip-text tip-content",e.image){const t=document.createElement("div");t.className="tip-content_image game-unit_tip-image",t.innerHTML=`<img src="${e.image.preview}" alt="">`,s.appendChild(t)}const a=document.createElement("div");a.className="tip-content_text content-markdown",a.innerHTML=e.html,s.appendChild(a),n.appendChild(s);const o=[];if(e.author&&o.push(`<span class="post-info__item post-info__item--user"><img src="${e.author.avatar}"><span>${e.author.username}</span></span>`),e.rating>0&&o.push(`<span class="post-info__item post-info__item--secondary"><i class="bi bi-heart"></i><span class="value">${e.rating}</span></span>`),o.length>0){const e=document.createElement("div");e.className="game-unit_tip-info",e.innerHTML='<div class="post-info">'+o.join("")+"</div>",n.appendChild(e)}n.addEventListener("click",(e=>{e.preventDefault(),this.openViewTipModal(i)})),t.appendChild(n)})),t.classList.remove("d-none"),t.scrollLeft=1,t.scrollLeft=0):n.classList.remove("d-none"):window.app.error(e.message)})).finally((()=>{t.classList.add("js-loaded"),i.remove()}))}_currentTipIndex=0;_viewTipModal=null;_viewTipModalNodes={};_tipVoteManager=null;openViewTipModal(e=0){if(0===this._tipsData.length)return;if(!this._viewTipModal){const e=$.A.render('<div class="modal fade modalViewTip" id="modalViewTip" tabindex="-1" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" data-l10n-key="view-tip-modal.title"></h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body px-0"> <div class="container-content"> <div class="post-info modalViewTip_tip-info mb-2" style="font-size:.9em"></div> <div class="tip-content mb-2"></div> <div class="post-info me-auto"> <button class="post-info__item post-like post-info__item--button" data-bs-toggle="tooltip"> <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 -960 960 960" fill="currentColor"> <path d="m480-170.93-36.15-32.69q-98.46-88.23-162.5-150.57-64.04-62.35-100.58-109.93-36.54-47.57-50.65-86.27Q116-589.08 116-629q0-80.15 55.42-135.58Q226.85-820 307-820q49.38 0 95 23.5t78 67.27q32.38-43.77 78-67.27 45.62-23.5 95-23.5 80.15 0 135.58 55.42Q844-709.15 844-629q0 39.92-13.62 77.61-13.61 37.7-50.15 84.77-36.54 47.08-100.89 110.43Q615-292.85 514.15-201.62L480-170.93Zm0-70.07q93-83.38 153-142.08 60-58.69 95.5-102.19t49.5-77.31q14-33.8 14-66.42 0-59-40-99t-99-40q-35.38 0-66.08 14.88-30.69 14.89-61.15 47.81l-35 41h-21.54l-35-41q-30.85-33.31-62.35-48Q340.38-768 307-768q-58.62 0-98.81 40Q168-688 168-629q0 32.62 13 64.92 13 32.31 47.5 75.31t95 102Q384-327.77 480-241Zm0-264Z"></path> </svg> <span class="value"></span> </button> <button class="post-info__item post-share post-info__item--button" data-bs-toggle="tooltip"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-share" viewBox="0 0 16 16"> <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/> </svg> </button> <button class="post-info__item post-report post-info__item--button" data-bs-toggle="tooltip" data-module="report"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16"> <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/> <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/> </svg> </button> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-sm btn-outline-primary modalViewTip_btn-prev"><i class="bi bi-chevron-left"></i></button> <div class="flex-grow-1"></div> <button type="button" class="btn btn-sm btn-outline-primary modalViewTip_btn-next"><i class="bi bi-chevron-right"></i></button> </div> </div> </div> </div>');document.body.appendChild(e);const t={modalNode:e,modalFooter:e.querySelector(".modal-footer"),btnPrev:e.querySelector(".modalViewTip_btn-prev"),btnNext:e.querySelector(".modalViewTip_btn-next"),tipInfo:e.querySelector(".modalViewTip_tip-info"),tipContent:e.querySelector(".tip-content"),btnLike:e.querySelector(".post-like"),likeCount:e.querySelector(".post-like .value"),btnShare:e.querySelector(".post-share"),btnReport:e.querySelector(".post-report")};this._viewTipModalNodes=t,this._tipsData.length<=1&&t.modalFooter.classList.add("d-none"),t.btnPrev.addEventListener("click",(()=>{this.openViewTipModal(this._currentTipIndex-1)})),t.btnNext.addEventListener("click",(()=>{this.openViewTipModal(this._currentTipIndex+1)})),t.btnLike.setAttribute("title",window.app.l10n("view-tip-modal.btn-like")),t.btnLike.addEventListener("click",(()=>{if(null===window.app.getLoginUser())return void window.GSEA?.open();const i=!e.classList.contains("post--liked")||null;this._tipVoteManager.vote(i).then((i=>{1===i.data.vote?(e.classList.add("post--liked"),this._tipsData[this._currentTipIndex].isLiked=!0):(e.classList.remove("post--liked"),this._tipsData[this._currentTipIndex].isLiked=!1);const n=window.app.getLang();null!==i.data.rating?(t.likeCount.innerText=new Intl.NumberFormat(n).format(i.data.rating),this._tipsData[this._currentTipIndex].rating=i.data.rating):(t.likeCount.innerText="0",this._tipsData[this._currentTipIndex].rating=0)})).catch((e=>{window.app.error(e.message)}))})),navigator.share?t.btnShare.addEventListener("click",(()=>{const e=this._tipsData[this._currentTipIndex]??null;if(null===e)return;const i={title:e.title,text:t.tipContent.innerText,url:window.location.origin+e.url};navigator.share(i)})):t.btnShare.remove(),[...e.querySelectorAll('[data-bs-toggle="tooltip"]')].map((e=>new u.Tooltip(e,{trigger:"hover"}))),this._viewTipModal=u.Modal.getOrCreateInstance(e)}e>=this._tipsData.length?e=0:e<0&&(e=this._tipsData.length-1),this._currentTipIndex=e;const t=this._tipsData[e]??null;if(null===t)return;if(this._viewTipModalNodes.tipContent.innerHTML="",t.image){const e=document.createElement("a");e.href=t.image.url,e.target="_blank",e.className="tip-content_image",e.innerHTML=`<img src="${t.image.preview}" alt="">`,e.setAttribute("data-pswp-width",t.image.width),e.setAttribute("data-pswp-height",t.image.height),this._viewTipModalNodes.tipContent.appendChild(e),window.app.loadModule("photoswipe").then((({default:e})=>{const t=new e.PhotoSwipeLightbox({gallery:".modalViewTip .tip-content_image",pswpModule:e.PhotoSwipe});t.on("uiRegister",(function(){t.pswp.ui.registerElement(e.downloadButtonConfig)})),t.init()}))}const i=document.createElement("div");i.className="tip-content_text content-markdown",i.innerHTML=t.html,this._viewTipModalNodes.tipContent.appendChild(i);const n=[];n.push(`<span class="post-info__item post-info__item--secondary">#${t.id}</span>`),t.author&&n.push(`<a href="${t.author.url}" class="post-info__item post-info__item--user"><img src="${t.author.avatar}"><span>${t.author.username}</span></a>`),this._viewTipModalNodes.tipInfo.innerHTML=n.join(""),t.rating>0?this._viewTipModalNodes.likeCount.innerText=t.rating:this._viewTipModalNodes.likeCount.innerHTML=`<small>${window.app.l10n("view-tip-modal.btn-like")}</small>`,this._viewTipModalNodes.btnReport.setAttribute("data-report-target",`p_${t.id}`),this._viewTipModalNodes.modalNode.classList.toggle("post--liked",t.isLiked),this._tipVoteManager=new o(t.id),this._viewTipModal.show()}openCreateTipModal(e=[]){null!==window.app.getLoginUser()?U.getOrCreateInstance().open({entities:e}):window.GSEA?.open()}isShowUnitProcess=!1;async showUnit(){if(this.isShowUnitProcess)return;if(null===window.app.getLoginUser())return void window.GSEA?.open();this.isShowUnitProcess=!0;let e=this.showInGameButton.innerHTML;this.showInGameButton.innerHTML=r.A;let t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("unit_id",this.unitId),window.GSEA?.jwt&&t.append("jwt",window.GSEA.jwt),window.app.helper.trackEvent("WIKI3_UBTN_GAMESHOW",{unit_id:this.gameId}),(0,s.A)("/api/gunitIngameShow",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?window.app.success(window.app.l10n("game-unit.ingame-show-open")):window.app.error(e.message)})).finally((()=>{this.showInGameButton.innerHTML=e,this.isShowUnitProcess=!1}))}isFavoriteProgress=!1;setFavorite(e){if(this.isFavoriteProgress)return;if(null===window.app.getLoginUser())return void window.GSEA?.open();this.isFavoriteProgress=!0;let t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("unit_id",this.unitId),t.append("value",e?1:0),(0,s.A)("/api/gunitFavorite",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?(this.rootNode.classList.toggle("game-unit--favorite",e.data.is_favorite||!1),this._setFavoriteCounter(e.data.count)):window.app.error(e.message)})).finally((()=>{this.isFavoriteProgress=!1}))}_setFavoriteCounter(e){this.rootNode.querySelectorAll(".game-unit_favorite-value").forEach((t=>{t.innerText=e,e>0&&t.classList.remove("d-none")}));let t=this.rootNode.querySelectorAll(".game-unit_favorite-label"),i=window.app.l10n("game-unit.favorite-player",{value:e});t.forEach((e=>{e.innerText=i}))}},"unit-filter":class{constructor(){switch(this.gameAssetCDN=window.app.helper.getGameAssetCDN(),this.filtersPanel=document.getElementById("wt-filters-panel"),this.startPage=document.getElementById("wt-start-page"),this.buttonShowTree=document.getElementById("wt-show-tree"),this.buttonShowList=document.getElementById("wt-show-list"),this.buttonClearFilters=document.getElementById("wt-clear-filters"),this.filterAmountLabel=document.getElementById("wt-filters-amount-label"),this.filterAmount=document.getElementById("wt-filters-amount"),this.filterSpinner=document.getElementById("wt-filters-spinner"),this.filterSearch=document.getElementById("wt-filter-search"),this.filterCountryButton=document.getElementById("wt-filter-country"),this.filterCountryItems=document.getElementById("wt-filter-country-items"),this.filterRankButton=document.getElementById("wt-filter-rank"),this.filterRankItems=document.getElementById("wt-filter-rank-items"),this.filterRoleButton=document.getElementById("wt-filter-role"),this.filterRoleItems=document.getElementById("wt-filter-role-items"),this.filterStatusButton=document.getElementById("wt-filter-status"),this.filterStatusItems=document.getElementById("wt-filter-status-items"),this.filterBRButton=document.getElementById("wt-filter-br"),this.filterBrSlidersNodes=document.querySelectorAll("#wt-filter-br-items .unit-filter_slider"),this.unitTreesBlock=document.getElementById("wt-unit-trees"),this.unitListBlock=document.getElementById("wt-unit-list"),this.collectionsButton=document.getElementById("wt-filter-collections"),this.collectionsModal=document.getElementById("wt-filter-collections-modal"),this.currentTreeNode=null,this.brModeButton=document.getElementById("wt-br-mode-btn"),this.brModeItems=document.getElementById("wt-br-mode-items"),this.treeTabs=document.getElementById("wt-tree-tabs"),this.defaultTitle=document.title,this.initFilters(),this.initTrees(),this.setBrMode("rb"),this._fillList(),this.getURLParam("v")){case"t":this.showTree(this.getURLParam("t_c"),!1);break;case"l":this.showList(!1);break;default:window.history.replaceState({v:null},null,window.location.href)}window.addEventListener("popstate",(e=>{if(e.state&&"v"in e.state)switch(e.state.v){case"t":this.showTree(e.state.t_c||null,!1);break;case"l":this.showList(!1);break;case null:this.showStartPage(!1)}})),this.filtersPanel.classList.remove("unready"),this.filterSpinner.style.display="none",window.addEventListener("resize",(()=>{this._updateCurrentTreeZoom()}))}_updateCurrentTreeZoom(){if(!this.currentTreeNode)return;const e=this.currentTreeNode.querySelector(".wt-tree"),t=this.currentTreeNode.querySelector(".wt-tree_wrapper"),i=this.currentTreeNode.querySelector(".unit-tree_zoom-wrapper");if(e.offsetWidth>=t.offsetWidth?i.classList.add("d-none"):i.classList.remove("d-none"),t.classList.contains("zoomed")){let i=e.offsetWidth/t.offsetWidth;t.style.transform=i>=1?"":`scale(${i})`}}getURLParam(e){return new URL(window.location.href).searchParams.get(e)}setURLParams(e,t=!0){if(t){let t=new URL(window.location.href);for(let i in e){let n=e[i];null===n?t.searchParams.delete(i):t.searchParams.set(i,n)}window.history.pushState(e,null,t)}}initFilters(){this._searchClearTextRegex=new RegExp(/[^0-9a-z-]/,"ig"),this.buttonShowTree.addEventListener("click",(()=>{this.buttonShowTree.classList.contains("active")?this.showStartPage():this.showTree()})),this.buttonShowList.addEventListener("click",(()=>{this.buttonShowList.classList.contains("active")?this.showStartPage():this.showList()})),this.buttonClearFilters.addEventListener("click",(()=>{this.clearFilters()})),this.units=JSON.parse(window.WT_UnitList)||[],this.unitLowerNames={},this.units.forEach((e=>{this.unitLowerNames[e[0]]=e[1].replace(this._searchClearTextRegex,"").toLowerCase()})),this.filterSearch.timer=void 0,this.filterSearch.addEventListener("input",(()=>{void 0!==this.filterSearch.timer&&clearTimeout(this.filterSearch.timer),this.filterSearch.timer=setTimeout((()=>{this.filter("s",this.filterSearch.value),this.filterSearch.timer=void 0,""!==this.filterSearch.value?this.filterSearch.classList.add("active"):this.filterSearch.classList.remove("active")}),500)})),this.filterCountryItems.querySelectorAll("[data-country-id]").forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("active");var t=[];this.filterCountryItems.querySelectorAll(".active[data-country-id]").forEach((e=>{t.push(e.getAttribute("data-country-id"))})),t.length>0?this.filterCountryButton.classList.add("active"):this.filterCountryButton.classList.remove("active"),this.filter("c",t)}))})),this.filterRankItems.querySelectorAll("[data-rank-id]").forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("active");var t=[];this.filterRankItems.querySelectorAll(".active[data-rank-id]").forEach((e=>{t.push(parseInt(e.getAttribute("data-rank-id")))})),t.length>0?this.filterRankButton.classList.add("active"):this.filterRankButton.classList.remove("active"),this.filter("r",t)}))})),this.filterRoleItems.addEventListener("click",(e=>{let t=e.target.closest("[data-collection-id]");if(!t)return;let i=this._currentFilters.rl||[],n=parseInt(t.getAttribute("data-collection-id"));i.includes(n)?i=i.filter((e=>e!==n)):i.push(n),this.filter("rl",i)})),this.filterStatusItems.querySelectorAll("[data-status-id]").forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("active");var t=[];this.filterStatusItems.querySelectorAll(".active[data-status-id]").forEach((e=>{t.push(parseInt(e.getAttribute("data-status-id")))})),t.length>0?this.filterStatusButton.classList.add("active"):this.filterStatusButton.classList.remove("active"),this.filter("exp",t)}))})),this.brSliders={},this.filterBrSlidersNodes.forEach((e=>{const t=e.getAttribute("data-filter-br"),i=parseInt(e.getAttribute("data-filter-br-max")),n=V.create(e,(e=>({start:[0,e],step:1,connect:!0,range:{min:0,max:e},tooltips:{to:e=>(Math.round(e/3*10)/10+1).toFixed(1)}}))(i));n.on("change",((e,n,s)=>{this.filter("br",{id:t,maxBr:i,data:s})})),this.brSliders[t]=n})),this.collectionsModal&&(this.collectionsModal.addEventListener("click",(e=>{if(!e.target.closest(".form-check"))return;let t=this.collectionsModal.querySelectorAll('[name="unit-collection"]:checked'),i={};t.forEach((e=>{let t=e.getAttribute("data-group-id"),n=parseInt(e.getAttribute("value"));i.hasOwnProperty(t)?i[t].push(n):i[t]=[n]})),this.filter("col",i)})),new u.Tab(this.collectionsModal.querySelector("#filter-group-tab:first-child button")).show()),this.brModeItems.addEventListener("click",(e=>{e.target.hasAttribute("data-br-id")&&this.setBrMode(e.target.getAttribute("data-br-id"))}))}initTrees(){this.treeTabs.querySelectorAll("[data-tree-target]").forEach((e=>{e.addEventListener("click",(()=>{this.showTree(e.getAttribute("data-tree-target"))}))})),document.addEventListener("click",(e=>{this.unitTreesBlock.querySelectorAll(".wt-tree_group.open").forEach((t=>{t.contains(e.target)||t.classList.remove("open")}))}));const e=document.createElement("span");e.className="br",this.unitTreesBlock.querySelectorAll(".wt-tree_item, .wt-tree_group.slave .wt-tree_group-folder_inner").forEach((t=>{t.append(e.cloneNode())}))}showTree(e=null,t=!0){if(this.startPage.style.display="none",this.unitListBlock.style.display="none",this.unitTreesBlock.style.display=null,this.buttonShowList.classList.remove("active"),this.buttonShowTree.classList.add("active"),null===e&&null!==this.getURLParam("t_c")&&(e=this.getURLParam("t_c")),"string"==typeof e?null===this.treeTabs.querySelector(`[data-tree-target="${e}"`)&&(e=null):e=null,null===e){var i=this.treeTabs.querySelector("[data-tree-target]");e=i.getAttribute("data-tree-target")}this.treeTabs.querySelectorAll("[data-tree-target]").forEach((t=>{t.getAttribute("data-tree-target")===e?(t.classList.add("active"),document.title=t.innerText.trim()+" | "+this.defaultTitle):t.classList.remove("active")})),this.unitTreesBlock.querySelectorAll(".unit-tree").forEach((t=>{t.getAttribute("data-tree-id")===e?(t.style.display=null,this.initTree(t.querySelector(".wt-tree")),this.currentTreeNode=t,this._updateCurrentTreeZoom()):t.style.display="none"})),this.setURLParams({v:"t",t_c:e},t)}showList(e=!0){document.title=this.buttonShowList.title+" | "+this.defaultTitle,this.startPage.style.display="none",this.unitTreesBlock.style.display="none",this.initList(),this.unitListBlock.style.display=null,this.buttonShowTree.classList.remove("active"),this.buttonShowList.classList.add("active"),this.currentTreeNode=null,this.setURLParams({v:"l"},e)}showStartPage(e=!0){document.title=this.defaultTitle,this.buttonShowList.classList.remove("active"),this.buttonShowTree.classList.remove("active"),this.startPage.style.display=null,this.unitTreesBlock.style.display="none",this.unitListBlock.style.display="none",this.currentTreeNode=null,this.setURLParams({v:null},e)}setBrMode(e){const t=this.brModeItems.querySelectorAll("button[data-br-id]");let i=null;t.forEach((t=>{t.getAttribute("data-br-id")===e?i=t:t.classList.remove("active")})),null===i&&(i=t[0],e=i.getAttribute("data-br-id")),this.brMode=e,i.classList.add("active"),this.brModeButton.innerText=i.getAttribute("data-br-sname"),this.unitListBlock.querySelectorAll(".wt-ulist_unit td.br").forEach((e=>{const t=e.parentElement.getAttribute("data-ulist-id"),i=this.units.find((e=>e[0]===t));e.innerText=void 0!==i[4][this.brMode]?this.convertBR(i[4][this.brMode]):"",e.setAttribute("data-value",i[4][this.brMode]??-1)})),this.unitTreesBlock.querySelectorAll(".wt-tree_item .br").forEach((e=>{const t=e.parentElement.getAttribute("data-unit-id"),i=this.units.find((e=>e[0]===t))[4][this.brMode]??null;if(null!==i){e.innerText=this.convertBR(i);const t=e.closest(".wt-tree_group.slave");if(t){const e=t.querySelector(".wt-tree_group-folder_inner .br");console.log(e),e&&(e.innerText=this.convertBR(i))}}}))}_highlightUnits(e){var t=this.unitListBlock.querySelector(".wt-ulist_instance");Array.from(t.tBodies[0].rows).forEach((t=>{var i=t.getAttribute("data-ulist-id");null==e?t.style.display=null:-1==e.indexOf(i)?t.style.display="none":t.style.display=null})),this.unitTreesBlock.querySelectorAll(".unit-tree").forEach((t=>{var i=t.querySelector(".wt-tree");if(null==e)return i.classList.remove("wt-tree--fade"),i.querySelectorAll(".wt-tree_item.highlight, .wt-tree_group.highlight").forEach((e=>{e.classList.remove("highlight")})),void this.treeTabs.querySelectorAll(".navtabs_item").forEach((e=>{e.classList.remove("highlight")}));i.classList.add("wt-tree--fade");var n=!1;i.querySelectorAll("td > .wt-tree_item[data-unit-id]").forEach((t=>{var i=t.getAttribute("data-unit-id");-1!=e.indexOf(i)?(n=!0,t.classList.add("highlight")):t.classList.remove("highlight")})),i.querySelectorAll("td > .wt-tree_group").forEach((t=>{var i=!1;t.querySelectorAll(".wt-tree_item[data-unit-id]").forEach((t=>{var s=t.getAttribute("data-unit-id");-1!=e.indexOf(s)?(n=!0,i=!0,t.classList.add("highlight")):t.classList.remove("highlight")})),i?t.classList.add("highlight"):t.classList.remove("highlight")}));var s=t.getAttribute("data-tree-id"),a=this.treeTabs.querySelector(`.navtabs_item[data-tree-target="${s}"]`);a&&(n?a.classList.add("highlight"):a.classList.remove("highlight"))}))}_findFilterMatch(){var e=[];return this.units.forEach((t=>{if(!(this._currentFilters.hasOwnProperty("s")&&-1==this.unitLowerNames[t[0]]?.indexOf(this._currentFilters.s)&&t[0]!==this._currentFilters.s_orig||this._currentFilters.hasOwnProperty("c")&&-1==this._currentFilters.c.indexOf(t[2])||this._currentFilters.hasOwnProperty("r")&&-1==this._currentFilters.r.indexOf(t[3])||this._currentFilters.hasOwnProperty("rl")&&0===this._currentFilters.rl.filter((e=>t[6].includes(e))).length||this._currentFilters.hasOwnProperty("exp")&&-1==this._currentFilters.exp.indexOf(t[5]))){if(this._currentFilters.hasOwnProperty("br"))for(let e in this._currentFilters.br)if(void 0===t[4][e]||t[4][e]<this._currentFilters.br[e][0]||t[4][e]>this._currentFilters.br[e][1])return;if(this._currentFilters.hasOwnProperty("col"))for(let e in this._currentFilters.col)if(0===this._currentFilters.col[e].filter((e=>t[6].includes(e))).length)return;e.push(t[0])}})),e}_currentFilters={};filter(e,t){switch(e){case"s":const i=t.replace(this._searchClearTextRegex,"").toLowerCase();""==i?(delete this._currentFilters.s,delete this._currentFilters.s_orig):(this._currentFilters.s=i,this._currentFilters.s_orig=t.toLowerCase().trim());break;case"c":case"r":case"rl":case"exp":0==t.length?delete this._currentFilters[e]:this._currentFilters[e]=t;break;case"br":let n=this._currentFilters.br??{};0==t.data.length||0==t.data[0]&&t.data[1]==t.maxBr?delete n[t.id]:n[t.id]=[Math.round(t.data[0]),Math.round(t.data[1])],Object.keys(n).length>0?this._currentFilters.br=n:delete this._currentFilters.br;break;case"col":(e=>{for(var t in e)return!1;return!0})(t)?delete this._currentFilters[e]:this._currentFilters[e]=t}if(0===Object.keys(this._currentFilters).length)this.clearFilters();else{this.filterAmountLabel.style.display=null,this.filterSpinner.style.display=null,"l"!=this.getURLParam("v")&&"t"!=this.getURLParam("v")&&this.showList();let e=this._findFilterMatch();this._highlightUnits(e),this.filterAmount.innerText=e.length,this.filterSpinner.style.display="none",this.filterAmount.style.display=null,this.buttonClearFilters.style.display=null;let t=this.filterRoleItems.querySelectorAll("[data-collection-id]"),i=this._currentFilters.rl||[];if(this.filterRoleButton.classList.toggle("active",i.length>0),t.forEach((e=>{let t=parseInt(e.getAttribute("data-collection-id"));e.classList.toggle("active",i.includes(t))})),this._currentFilters.hasOwnProperty("br")?this.filterBRButton.classList.add("active"):this.filterBRButton.classList.remove("active"),this.collectionsButton&&(this._currentFilters.hasOwnProperty("col")?this.collectionsButton.classList.add("active"):this.collectionsButton.classList.remove("active")),this.collectionsModal){const e=this._currentFilters.col||{},t=Object.values(e);let i=[];t.forEach((e=>{i=i.concat(...e)})),this.collectionsModal.querySelectorAll('[name="unit-collection"]').forEach((e=>{const t=parseInt(e.getAttribute("value"));e.checked=i.includes(t)}))}}}clearFilters(){this.filterAmount.style.display="none",this.filterAmountLabel.style.display="none",this.filterSpinner.style.display="none",this.buttonClearFilters.style.display="none",this.filterSearch.value="",this.filterSearch.classList.remove("active"),this.filterCountryButton.classList.remove("active"),this.filterCountryItems.querySelectorAll(".active[data-country-id]").forEach((e=>{e.classList.remove("active")})),this.filterRankButton.classList.remove("active"),this.filterRankItems.querySelectorAll(".active[data-rank-id]").forEach((e=>{e.classList.remove("active")})),this.filterRoleButton.classList.remove("active"),this.filterRoleItems.querySelectorAll(".active[data-collection-id]").forEach((e=>{e.classList.remove("active")})),this.filterStatusButton.classList.remove("active"),this.filterStatusItems.querySelectorAll(".active[data-status-id]").forEach((e=>{e.classList.remove("active")})),this.filterBRButton.classList.remove("active");for(let e in this.brSliders)this.brSliders[e].reset();this.collectionsModal&&(this.collectionsButton.classList.remove("active"),this.collectionsModal.querySelectorAll('[name="unit-collection"]:checked').forEach((e=>{e.checked=!1}))),this._currentFilters={},this._highlightUnits(null)}initTree(e){if(e.classList.contains("js-loaded"))return;const t=e.querySelector(".wt-tree_footer");e.querySelectorAll(".wt-tree_group").forEach((i=>{i.addEventListener("click",(()=>{i.classList.add("open");const n=i.querySelector(".wt-tree_group-items");if(!i.classList.contains("js-loaded")){var s=i.querySelector(".wt-tree_group-canvas");s.width=n.clientWidth,s.height=n.clientHeight;let e=new H(i,s);e.getCtx().fillStyle="#607D8B",i.querySelectorAll("[data-unit-req]").forEach((t=>{if(i.contains(t)){var n=t.getAttribute("data-unit-req"),s=i.querySelector(`[data-unit-id="${n}"]`);s&&e.draw(s,t)}})),i.classList.add("js-loaded")}const a=H.getPosFromNode(e,document)[1],o=e.getBoundingClientRect().height,r=H.getPosFromNode(n,document)[1]+n.getBoundingClientRect().height-(a+o);r>0&&(t.style.height=parseInt(r)+25+"px")}))})),window.getComputedStyle(document.body).marginTop;var i=e.querySelector(".wt-tree-canvas");i.height=e.clientHeight;let n=new H(e,i);n.getCtx().fillStyle="#607D8B",e.querySelectorAll("td > [data-unit-req]").forEach((t=>{if(!e.contains(t))return;const i=t.getAttribute("data-unit-req"),s=e.querySelector(`[data-unit-id="${i}"]`);if(s){if(!t.closest(".wt-tree_group")){const e=s.closest(".wt-tree_group");if(e)return void n.draw(e,t)}n.draw(s,t)}}));let s=e.querySelector(".wt-tree_wrapper");const a='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 -960 960 960" fill="currentColor"><path d="M765-144 526-384q-30 23-65.792 35.5T384.035-336Q284-336 214-406t-70-170q0-100 70-170t170-70q100 0 170 70t70 170.035q0 40.381-12.5 76.173T577-434l239 239-51 51ZM384-408q70 0 119-49t49-119q0-70-49-119t-119-49q-70 0-119 49t-49 119q0 70 49 119t119 49Zm-96-132v-72h192v72H288Z"></path></svg>',o=document.createElement("div");o.className="unit-tree_zoom-wrapper";const r=document.createElement("button");r.className="unit-tree_zoom",r.innerHTML=a,r.addEventListener("click",(()=>{if(s.classList.contains("zoomed"))r.innerHTML=a,e.style.overflowX="",e.style.height="",s.style.transform="",s.classList.remove("zoomed");else{let t=e.offsetWidth/s.offsetWidth;s.style.transform=t>=1?"":`scale(${t})`,e.scrollLeft=0,e.style.overflowX="hidden";let i=s.offsetHeight*t;e.style.height=i+"px",r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 -960 960 960" fill="currentColor"><path d="M765-144 526-384q-30 23-65.792 35.5T384.035-336Q284-336 214-406t-70-170q0-100 70-170t170-70q100 0 170 70t70 170.035q0 40.381-12.5 76.173T577-434l239 239-51 51ZM384-408q70 0 119-49t49-119q0-70-49-119t-119-49q-70 0-119 49t-49 119q0 70 49 119t119 49Zm-36-60v-72h-72v-72h72v-72h72v72h72v72h-72v72h-72Z"/></svg>',s.classList.add("zoomed")}})),o.appendChild(r),e.after(o),e.classList.add("js-loaded")}_fillList(){let e=this.unitListBlock.querySelector(".wt-ulist tbody");if(0!==e.childElementCount)return;let t=new DocumentFragment,i=document.getElementById("wt-ulist_list-row-template");this.units.forEach((e=>{let n=i.content.cloneNode(!0),s=n.querySelector("tr");switch(s.setAttribute("data-ulist-id",e[0]),e[5]){case 0:s.classList.add("wt-ulist_unit--regular");break;case 1:s.classList.add("wt-ulist_unit--prem");break;case 2:s.classList.add("wt-ulist_unit--squad")}let a=n.querySelectorAll("td");const o=e[7][2]||e[0];if(a[0].innerHTML=`<a href="/unit/${e[0]}"><img src="${this.gameAssetCDN}/icons/${o}_ico.svg" loading="lazy" decoding="async"><span>${e[1]}</span></a>`,a[1].innerHTML=`<svg width="18" height="18" viewBox="0 0 10 10" color="${e[7][0][2]}"><use href="/static/class_icon/${e[7][0][0]}.svg#icon" width="10" height="10" x="0" y="0"></use></svg><span class="ms-1">${e[7][0][1]}</span>`,a[2].setAttribute("data-value",e[2]),a[2].innerHTML=`<img src="/static/country_svg/country_${e[2]}.svg" loading="lazy" decoding="async">`,a[3].setAttribute("data-value",e[3]),a[3].innerText=this.convertRankRoman(e[3]),a[4].setAttribute("data-value",e[4][this.brMode]??-1),a[4].innerText=void 0!==e[4][this.brMode]?this.convertBR(e[4][this.brMode]):"",0===e[7][1].length)a[5].setAttribute("data-value",-1),a[5].innerText="";else{a[5].setAttribute("data-value",e[7][1][0]);let t="";e[7][1][0]>0&&("g"===e[7][1][2]?t="item_type_eagles":"w"===e[7][1][2]&&(t="item_type_warpoints")),a[5].innerHTML=e[7][1][1]+(t?` <img src="${this.gameAssetCDN}/gui_skin/${t}.svg" width="18px" loading="lazy" decoding="async">`:"")}t.append(n)})),e.append(t)}initList(){let e=this.unitListBlock.querySelector(".wt-ulist");e.classList.contains("js-loaded")||(this.unitList=new z.A(e),e.classList.add("js-loaded"))}convertRankRoman(e){switch(e){case 1:return"I";case 2:return"II";case 3:return"III";case 4:return"IV";case 5:return"V";case 6:return"VI";case 7:return"VII";case 8:return"VIII";case 9:return"IX";case 10:return"X"}return""}convertBR(e){return(e/3+1).toFixed(1)}},"unit-compare":class{constructor(){try{let e=document.getElementById("unit-compare_initial"),t=JSON.parse(e.value);if(0===t.trees.length||0===t.unitsData.length||0===Object.keys(t.typesConfig).length)throw new Error("Empty params");this.compareConfig=t}catch(e){return window.app.error(window.app.l10n("unit-compare.init-error")),void console.log(e)}this.gameAssetCDN=window.app.helper.getGameAssetCDN(),this.defaultTitle=document.title,this.nodes={root:document.querySelector(".unit-compare"),treeTabsContainer:document.querySelector(".unit-compare_tree-tabs"),unitItemsContainer:document.querySelector(".unit-compare_items"),dataSectionsContainer:document.querySelector(".unit-compare_sections"),templateUnitItem:document.getElementById("tpl-unit-compare-item"),templateUnitItemEmpty:document.getElementById("tpl-unit-compare-empty"),templateSection:document.getElementById("tpl-unit-compare-section"),buttonShare:document.getElementById("btn-unit-compare-share"),buttonClean:document.getElementById("buttonCleanList"),buttonSelectTreeDropdown:document.getElementById("btn-select-tree-dropdown"),switchOnlyDiff:document.getElementById("switchOnlyDiff"),selectModal:document.getElementById("unitCompareSelectModal"),modalSelectItems:document.querySelector(".unit-compare_select-items"),miniHeader:document.querySelector(".unit-compare_mini-header"),btnModeRealistic:document.getElementById("switchModRealistic"),btnModeArcade:document.getElementById("switchModArcade")},this.nodes.btnModeRealistic.addEventListener("click",(()=>{this.nodes.root.classList.remove("cur-char-ab"),this.nodes.root.classList.add("cur-char-rb")})),this.nodes.btnModeArcade.addEventListener("click",(()=>{this.nodes.root.classList.remove("cur-char-rb"),this.nodes.root.classList.add("cur-char-ab")}));let e={};this.compareConfig.unitsData.forEach((t=>{let i=t.tree;e.hasOwnProperty(i)?e[i]++:e[i]=1})),this.trees={},this.compareConfig.trees.forEach((t=>{if(!e.hasOwnProperty(t.id))return;t.unitCount=e[t.id];let i=document.createElement("button");i.type="button",i.className="feed-filter",i.innerHTML=`${t.label} <span class="badge text-bg-primary ms-2">${t.unitCount}</span>`,i.addEventListener("click",(()=>{this.setCurrentTree(t.id)})),this.nodes.treeTabsContainer.append(i),t.tabButton=i,this.trees[t.id]=t})),this.maxColumn=this._getMaxColumn(),this.currentUnitsId=null;let t=null,i=this.getURLParam("unitIds");i&&0!==i.trim().length&&(t=i.split(",").slice(0,this.maxColumn));let n=parseInt(this.getURLParam("tree"));this.setCurrentTree(n,t),this.nodes.buttonShare.addEventListener("click",(()=>{const e=new URL(window.location.href);if(navigator.share){const t={title:document.title,url:e};navigator.share(t)}else navigator.clipboard?navigator.clipboard.writeText(e.toString()).then((()=>{window.app.success(window.app.l10n("comment.link-copy"))})).catch((e=>{window.app.error(window.app.l10n("comment.link-copy-error"))})):window.app.error(window.app.l10n("comment.link-copy-error"))})),this.nodes.buttonClean.addEventListener("click",(()=>{window.app.deleteCookie("unitsCompare"),window.location.href="/"})),this.showOnlyDiff=!1,this.nodes.switchOnlyDiff.addEventListener("change",(()=>{this.showOnlyDiff=this.nodes.switchOnlyDiff.checked,this._showForTree()})),this.selectModalBs=u.Modal.getOrCreateInstance(this.nodes.selectModal),window.addEventListener("resize",(()=>{let e=this._getMaxColumn();this.maxColumn!==e&&(this.maxColumn=e,this._showForTree())})),document.addEventListener("scroll",(()=>{let e=this.nodes.unitItemsContainer.getBoundingClientRect();this.nodes.miniHeader.classList.toggle("show",e.bottom-50<0)}))}_getMaxColumn(){let e=parseInt(window.getComputedStyle(document.body).getPropertyValue("--bs-breakpoint-md"));return window.innerWidth>=e?4:2}getURLParam(e){return new URL(window.location.href).searchParams.get(e)}setCurrentTree(e,t=null){if(!((e=parseInt(e))in this.trees)){let e=Object.keys(this.trees);return 0===e.length?void(window.location.href="/"):void this.setCurrentTree(e[0])}this.currentUnitsId=null,this.currentTree=e;for(let t in this.trees)this.trees[t].tabButton.classList.toggle("active",this.trees[t].id===e),this.trees[t].id===e&&(this.nodes.buttonSelectTreeDropdown.innerHTML=this.trees[t].tabButton.innerHTML);this._showForTree(t)}_showForTree(e=null){let t=[],i=[];if(null===this.currentUnitsId&&null===e)for(let e in this.compareConfig.unitsData){let n=this.compareConfig.unitsData[e];if(n.tree===this.currentTree&&(t.push(n.gameId),i.push(n)),i.length>=this.maxColumn)break}else(e||this.currentUnitsId).forEach((e=>{let n=this.compareConfig.unitsData.find((t=>t.gameId===e&&t.tree===this.currentTree));n&&(t.includes(e)||(t.push(e),i.push(n)))})),t=t.slice(0,this.maxColumn),i=i.slice(0,this.maxColumn);this.currentUnitsId=t;const n=new URL(window.location.href);n.searchParams.set("tree",this.currentTree),n.searchParams.set("unitIds",this.currentUnitsId.join(",")),window.history.replaceState({},null,n);const s=[];i.forEach((e=>{s.push(e.title)})),s.length>1?document.title=s.join(" vs ")+" | "+this.defaultTitle:document.title=this.defaultTitle,this._drawCompare(i),this._drawSelectModal()}_drawSelectModal(){let e=[];this.compareConfig.unitsData.forEach((t=>{t.tree===this.currentTree&&e.push(t)})),e.sort(((e,t)=>e.gameId>t.gameId)),this.nodes.modalSelectItems.innerHTML="",e.forEach((e=>{let t=this._getUnitSelectElem(e);this.nodes.modalSelectItems.append(t)}))}_drawCompare(e){let t=this.trees[this.currentTree];if(this.nodes.unitItemsContainer.innerHTML="",this.nodes.dataSectionsContainer.innerHTML="",e.forEach((e=>{let t=this._getUnitCardElem(e);this.nodes.unitItemsContainer.append(t),this.nodes.miniHeader.innerHTML=this.nodes.unitItemsContainer.innerHTML})),e.length<this.maxColumn){let i=this.nodes.templateUnitItemEmpty.content.cloneNode(!0),n={buttonAdd:i.querySelector(".unit-compare_empty-item_btn-add"),buttonSearch:i.querySelector(".unit-compare_empty-item_btn-search")};t.unitCount>e.length?n.buttonAdd.addEventListener("click",(()=>{this._openChangeUnitModal()})):n.buttonAdd.remove(),n.buttonSearch.addEventListener("click",(()=>{let e="/";switch(this.currentTree){case 0:e="/aviation";break;case 1:e="/helicopters";break;case 2:e="/ground";break;case 3:e="/ships";break;case 4:e="/boats"}window.location.href=e})),this.nodes.unitItemsContainer.append(i)}if(e.length>0){let i=this.compareConfig.typesConfig[t.unitType],n=1;i.forEach((t=>{let i=[];if(t.rows.forEach((t=>{let n=[],s=[];if(e.forEach((e=>{t.id in e.compareData?(n.push(e.compareData[t.id]),"value"in e.compareData[t.id]&&s.push(e.compareData[t.id].value)):n.push(null)})),n.every((e=>null===e)))return;let a=n.every((e=>n[0]?.label===e?.label));this.showOnlyDiff&&a||(t.data=n,1===t.compareMethod?t.maxValue=a?null:Math.max(...s):2===t.compareMethod&&(t.minValue=a?null:Math.min(...s)),i.push(t))})),0===i.length)return;let s=this.nodes.templateSection.content.cloneNode(!0),a={sectionHeader:s.querySelector(".accordion-button"),sectionContent:s.querySelector(".accordion-body"),sectionContentWrapper:s.querySelector(".accordion-collapse")},o=`unit-compare-section-${n}`;a.sectionHeader.setAttribute("data-bs-target","#"+o),a.sectionHeader.setAttribute("aria-controls",o),a.sectionHeader.innerText=t.title,a.sectionContentWrapper.id=o,n++,i.forEach((e=>{let t=document.createElement("div");t.className="unit-compare_row";let i=document.createElement("div");i.className="unit-compare_row-header",i.innerText=e.title;let n=document.createElement("div");n.className="unit-compare_row-content",e.data.forEach((t=>{let i=document.createElement("div");i.className="unit-compare_row-value",i.innerHTML=null===t?e.emptyLabel||"":t.label,e.data.length>1&&(1===e.compareMethod&&t?.value===e.maxValue||2===e.compareMethod&&t?.value===e.minValue)&&i.classList.add("highlight"),n.append(i)})),t.append(i),t.append(n),a.sectionContent.append(t)})),this.nodes.dataSectionsContainer.append(s)}))}}_openChangeUnitModal(e=null){this.changedUnitId=e,this.selectModalBs.show()}_getUnitCardElem(e){let t=this._getUnitElem(e),i={itemBtnChange:t.querySelector(".unit-compare_item-btn-change"),itemBtnRemove:t.querySelector(".unit-compare_item-btn-remove")};return i.itemBtnChange.addEventListener("click",(()=>{this._openChangeUnitModal(e.gameId)})),i.itemBtnRemove.addEventListener("click",(()=>{this.removeFromShow(e.gameId)})),t}_getUnitSelectElem(e){const t=this._getUnitElem(e),i={root:t.querySelector(".unit-compare_item"),itemBtnChange:t.querySelector(".unit-compare_item-btn-change"),itemBtnRemove:t.querySelector(".unit-compare_item-btn-remove")};return this.currentUnitsId.includes(e.gameId)&&i.root.classList.add("active"),i.itemBtnChange.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M450.001-450.001h-230v-59.998h230v-230h59.998v230h230v59.998h-230v230h-59.998v-230Z"/></svg>',i.itemBtnChange.addEventListener("click",(()=>{if(this.changedUnitId){const t=this.currentUnitsId.indexOf(e.gameId),i=this.currentUnitsId.indexOf(this.changedUnitId);if(-1!==i&&-1!==t){let e=this.currentUnitsId[i];this.currentUnitsId[i]=this.currentUnitsId[t],this.currentUnitsId[t]=e}else-1!==i?this.currentUnitsId[i]=e.gameId:this.currentUnitsId.push(e.gameId)}else this.currentUnitsId.push(e.gameId);this._showForTree(),this.selectModalBs.hide()})),i.itemBtnRemove.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 -960 960 960" fill="currentColor"><path d="M324.309-164.001q-26.623 0-45.465-18.843-18.843-18.842-18.843-45.465V-696h-48v-51.999H384v-43.384h192v43.384h171.999V-696h-48v467.257q0 27.742-18.65 46.242-18.65 18.5-45.658 18.5H324.309ZM648-696H312v467.691q0 5.385 3.462 8.847 3.462 3.462 8.847 3.462h311.382q4.616 0 8.463-3.846 3.846-3.847 3.846-8.463V-696ZM400.155-288h51.999v-336h-51.999v336Zm107.691 0h51.999v-336h-51.999v336ZM312-696V-216v-480Z" /></svg>',i.itemBtnRemove.addEventListener("click",(()=>{i.root.remove(),this.removeUnit(e.gameId)})),t}_getUnitElem(e){let t=this.nodes.templateUnitItem.content.cloneNode(!0),i={itemFlag:t.querySelector(".unit-compare_item-flag"),itemImg:t.querySelector(".unit-compare_item-img"),itemLink:t.querySelector(".unit-compare_item-title"),itemTitle:t.querySelector(".unit-compare_item-title span"),itemPremIcon:t.querySelector(".unit-compare_item-title img"),itemCountryFlag:t.querySelector(".unit-compare_item-country img"),itemCountryName:t.querySelector(".unit-compare_item-country div"),itemRank:t.querySelector(".unit-compare_item-rank")};const n=e.originCountry||e.country.id,s=e.unitImageId||e.gameId;return i.itemFlag.src=`${this.gameAssetCDN}/unit_tooltip/country_${n}.png`,i.itemImg.src=`${this.gameAssetCDN}/images/${s}.png`,i.itemLink.href=e.link,i.itemTitle.innerText=e.name,i.itemCountryFlag.src=`/static/country_svg/country_${e.country.id}.svg`,i.itemCountryName.innerText=e.country.label,i.itemRank.innerText=e.rank,1!==e.expType&&i.itemPremIcon.remove(),t}removeFromShow(e){this.currentUnitsId=this.currentUnitsId.filter((t=>t!==e)),this._showForTree()}removeUnit(e){let t=this.compareConfig.unitsData.find((t=>t.gameId===e));if(!t)return;this.compareConfig.unitsData=this.compareConfig.unitsData.filter((e=>e.gameId!==t.gameId));let i=window.app.getCookie("unitsCompare"),n=[];try{n=JSON.parse(i)}catch(e){n=[]}Array.isArray(n)||(n=[]),n=n.filter((e=>e!==t.gameId)),0===n.length?window.app.deleteCookie("unitsCompare"):window.app.setCookie("unitsCompare",JSON.stringify(n));let s=t.tree;this.trees[s].unitCount--,0===this.trees[s].unitCount?(this.trees[s].tabButton.remove(),delete this.trees[s],this.setCurrentTree(null)):(this.trees[s].tabButton.querySelector(".badge").innerText=this.trees[s].unitCount,this.nodes.buttonSelectTreeDropdown.innerHTML=this.trees[s].tabButton.innerHTML,this.currentUnitsId.includes(t.gameId)&&this.removeFromShow(t.gameId))}},"unit-records":class{constructor(){try{const e=document.getElementById("unit-record_initial"),t=JSON.parse(e.value);if(0===Object.keys(t).length)throw new Error("Empty params");this.recordsConfig=t}catch(e){return window.app.error(window.app.l10n("unit-compare.init-error")),void console.log(e)}this.nodes={tplRecordBlock:document.getElementById("tpl-unit-record-block"),tplRecordPodium:document.getElementById("tpl-unit-record-podium"),tplRecordPlace:document.getElementById("tpl-unit-record-place"),tplRecordUnit:document.getElementById("tpl-unit-record-unit"),recordPreloader:document.getElementById("unit-record_preloader"),recordBlocksList:document.getElementById("unit-record_list"),modalAllVehiclesNode:document.getElementById("unit-record_modalAllVehicles")},this.modalAllVehicles=u.Modal.getOrCreateInstance(this.nodes.modalAllVehiclesNode),this.gameAssetCDN=window.app.helper.getGameAssetCDN(),this.recordsConfig.nominations.forEach((e=>{const t=this.nodes.tplRecordBlock.content.cloneNode(!0),i={root:t.querySelector(".unit-record"),title:t.querySelector(".unit-record_title"),subtitle:t.querySelector(".unit-record_subtitle"),countrySwitchButton:t.querySelector(".unit-record_country-switch .dropdown-toggle"),countrySwitchItems:t.querySelector(".unit-record_country-switch .dropdown-menu"),content:t.querySelector(".unit-record_content")};i.countrySwitchItems.addEventListener("click",(e=>{const t=e.target.closest("button.dropdown-item");if(!t)return;i.countrySwitchItems.querySelectorAll("button.active").forEach((e=>{e.classList.remove("active")})),t.classList.add("active");const n=t.getAttribute("data-country");i.content.querySelectorAll(".unit-record_items-wrapper").forEach((e=>{const t=e.getAttribute("data-country");if(e.classList.toggle("d-none",!(t===n)),t===n){const t=e.querySelector(".arrow-scroll_wrapper");t.scrollLeft=1,t.scrollLeft=0}})),i.countrySwitchButton.innerHTML=this.recordsConfig.countries[n].icon})),i.root.id=e.id,i.title.innerText=e.title,e.subtitle?i.subtitle.innerText=e.subtitle:i.subtitle.remove();const n=e.resultByCountry[0].countryId;i.countrySwitchButton.innerHTML=this.recordsConfig.countries[n].icon,e.resultByCountry.forEach((t=>{const s=t.countryId,a=this.recordsConfig.countries[s],o=document.createElement("button");o.className="dropdown-item",o.classList.toggle("active",s===n),o.innerHTML=`<div class="icon">${a.icon}</div><div class="text-truncate">${a.label}</div>`,o.setAttribute("data-country",s);let r=null;r=s===n?i.countrySwitchItems.querySelector(".main_button"):i.countrySwitchItems.querySelector(".sub_buttons"),r.appendChild(o);const l=this.nodes.tplRecordPodium.content.cloneNode(!0),d={root:l.querySelector(".unit-record_items-wrapper"),itemsContainer:l.querySelector(".unit-record_items")};d.root.setAttribute("data-country",s),d.root.classList.toggle("d-none",!(n===s)),t.valuesInOrder.forEach(((i,n)=>{const s=this.nodes.tplRecordPlace.content.cloneNode(!0),o={root:s.querySelector(".unit-record_item"),placeValue:s.querySelector(".unit-record_item-place .value .place-num"),placeText:s.querySelector(".unit-record_item-place .value .place-text"),resultValue:s.querySelector(".unit-record_item-value"),unitCard:s.querySelector(".unit-record_item-card"),moreButton:s.querySelector(".unit-record_item-more button")},r=n+1,l=window.app.l10n("unit-records.place-value-label",{place:r}),c=i.value,u=i.label;o.root.classList.add(`place-${r}`),o.placeValue.innerHTML=l,o.placeText.innerText=window.app.l10n("unit-records.place-text-label"),o.resultValue.innerHTML=`<div>${u}</div>`;const m=t.vehiclesByValue[c],h=m[Math.floor(Math.random()*m.length)],p=h.id;if(h.subvalue){const e=document.createElement("div");e.className="subvalue",e.innerText=h.subvalue,o.resultValue.appendChild(e)}const g=this.recordsConfig.units[p],w=this.createUnitCard(g,this.recordsConfig.countries);if(o.unitCard.appendChild(w),m.length>1){o.moreButton.innerText=window.app.l10n("unit-records.btn-more",{count:m.length-1});const t=[];m.forEach((e=>{t.push(this.recordsConfig.units[e.id])})),o.moreButton.addEventListener("click",(()=>{this.openPopupWithVehicles(t,e.title,l+" "+window.app.l10n("unit-records.place-text-label"),a.label)}))}else o.moreButton.remove();d.itemsContainer.appendChild(s)})),i.content.appendChild(l)})),this.nodes.recordBlocksList.appendChild(t)})),this.nodes.recordBlocksList.classList.remove("d-none"),this.nodes.recordPreloader.remove()}createUnitCard(e,t){const i=this.nodes.tplRecordUnit.content.cloneNode(!0),n={root:i.querySelector(".favorite-units_item"),imgOperatorFlag:i.querySelector(".favorite-units_item-flag"),imgUnitImage:i.querySelector(".favorite-units_item-img"),imgTalisman:i.querySelector(".favorite-units_item-title img"),unitName:i.querySelector(".favorite-units_item-title span"),imgCountryFlag:i.querySelector(".favorite-units_item-country img"),countryName:i.querySelector(".favorite-units_item-country div"),rank:i.querySelector(".favorite-units_item-rank")};n.root.href=`/unit/${e.unit_id}`,n.unitName.innerText=e.name,1!==e.exp_type&&n.imgTalisman.remove();const s=e.origin_country||e.country;n.imgOperatorFlag.src=`${this.gameAssetCDN}/unit_tooltip/country_${s}.png`;const a=e.image_id||e.unit_id;return n.imgUnitImage.src=`${this.gameAssetCDN}/images/${a}.png`,n.imgCountryFlag.src=`/static/country_svg/country_${e.country}.svg`,n.countryName.innerText=t[e.country].label,n.rank.innerText=e.rank,i}openPopupWithVehicles(e,t,i,n){const s={title:this.nodes.modalAllVehiclesNode.querySelector(".modal-title"),subtitle:this.nodes.modalAllVehiclesNode.querySelector(".modal-subtitle"),itemsContainer:this.nodes.modalAllVehiclesNode.querySelector(".unit-record_modal-items")};s.title.innerText=t,s.subtitle.innerHTML=`${n} | ${i}`,s.itemsContainer.innerHTML="",e.forEach((e=>{const t=this.createUnitCard(e,this.recordsConfig.countries),i=document.createElement("div");i.className="unit-record_item-card",i.appendChild(t),s.itemsContainer.appendChild(i)})),this.modalAllVehicles.show()}convertRankRoman(e){switch(e){case 1:return"I";case 2:return"II";case 3:return"III";case 4:return"IV";case 5:return"V";case 6:return"VI";case 7:return"VII";case 8:return"VIII";case 9:return"IX";case 10:return"X"}return""}},"unit-collection":class{constructor(){let e=document.getElementById("unit-collection_feed");if(e){this.feed=d.init(e);let t=document.getElementById("unit-collection_feed-nav");t&&t.addEventListener("click",(e=>{let i=e.target.closest("[data-feed-sort]");if(i){let e=i.getAttribute("data-feed-sort");this.feed.atributes.sort=e,t.querySelectorAll(".active[data-feed-sort]").forEach((e=>{e.classList.remove("active")})),i.classList.add("active"),this.feed.refresh()}}))}}},ticket:j.A,"ticket-list":class{constructor(){let e=document.getElementById("modal-new-ticket"),t=e.querySelector(".comment-form");this.btnSendTicketElem=document.getElementById("modalBtnSendTicket"),this.btnSendTicketElem&&t&&(this.commentForm=new h.A(t,{target:"ticket"}),this.btnSendTicketElem.addEventListener("click",(()=>{this.create()})),e.addEventListener("show.bs.modal",(()=>{this.commentForm.clear()})))}_isProcess=!1;async create(){if(this._isProcess)return Promise.reject();let e=this.commentForm.getValues();if(!("text"in e&&0!==e.text.trim().length||"img-uuid"in e))return window.app.warning(window.app.l10n("comment.error_empty")),Promise.reject();this._isProcess=!0;var t=new FormData;t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),"text"in e&&t.append("text",e.text.trim()),"img-uuid"in e&&t.append("img-uuid",e["img-uuid"]);let i=this.btnSendTicketElem.innerText;return this.btnSendTicketElem.innerHTML=r.A,this.btnSendTicketElem.disabled=!0,(0,s.A)("/api/createTicket",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?(window.app.success(window.app.l10n("report-popup.send")),window.location.href="/u/ticket/"+e.data.ticket_id):window.app.error(e.message)})).finally((e=>{this._isProcess=!1,this.btnSendTicketElem.innerText=i,this.btnSendTicketElem.disabled=!1}))}}},te={"layout-theme-switcher":class{static call(e){let t=e.querySelector(".layout-nav_theme-selector"),i=e=>{window.app.setTheme(e.getAttribute("data-theme")),t.innerText=e.innerText.trim()},n=e.querySelector(".dropdown-menu");n.addEventListener("click",(e=>{let t=e.target.closest("[data-theme]");t&&i(t)}));let s="auto",a=localStorage.getItem("preferTheme");"light"!==a&&"dark"!==a||(s=a);let o=n.querySelector(`[data-theme="${s}"]`);o&&i(o)}},"unit-list":G.A,"delete-draft":class{static init(){document.addEventListener("click",(e=>{let t=e.target.closest('[data-module="delete-draft"]');if(t){let e=parseInt(t.getAttribute("data-post-id"));W.getOrCreateInstance().open(e)}}))}},"comment-mod":Z.A,"comment-rules":class{static call(e){e.addEventListener("click",(e=>{J.getOrCreateInstance().open()}))}},"markdown-help":X.A,"bs-auto-tooltip":Q.A,"login-button":class{static call(e){const t=()=>{e.classList.contains("loading")&&(e.classList.remove("loading"),e.classList.add("loaded"),e.addEventListener("click",(()=>{window.GSEA.open()})))};window.GSEA?t():(window.GSEA_init=window.GSEA_init??{onLoad:[]},window.GSEA_init.onLoad.push(t),setTimeout((()=>{window.GSEA&&t()}),1e3))}},"info-block-place":Y,"search-popup":class{static call(e){e.addEventListener("click",(()=>{K.getOrCreateInstance().open()}))}},"edit-tip":class{static call(e){e.addEventListener("click",(()=>{const t=e.getAttribute("data-post-id");if(!t)return;if(null===window.app.getLoginUser())return void window.GSEA?.open();const i=new FormData;i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("post_id",t),(0,s.A)("/api/getSourceTip",{method:"POST",credentials:"include",body:i}).then((e=>{e.success?U.getOrCreateInstance().open(e.data):window.app.error(e.message)}))}))}}};new n.A(ee,te)},633:(e,t,i)=>{i.d(t,{A:()=>r});var n=i(202);const s="asjs",a=`.${s}`,o='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>';class r{constructor(e,t={}){this.formName=t.formName||"",this._isInitialize=!1,this.placeholder=t.placeholder||"",this.emptyPlaceholder=t.emptyPlaceholder||window.app.l10n("selector.list_empty"),this.newPlaceholder=t.newPlaceholder||window.app.l10n("selector.add_new"),this.limitPlaceholder=t.limitPlaceholder||window.app.l10n("selector.limit"),this.selectedPlaceholder=this.selectedPlaceholder||window.app.l10n("selector.selected"),this.maxSize=t.maxSize||null,this.multiselect=t.multiselect||!1,this.sortable=t.sortable||!1,this.allowNew=t.allowNew||!1,this.required=t.required||!1;let i=document.createElement("div");if(i.className=s,this.items=t.items||[],this.values=[],this._selectItems={},this.searchEndpoint=t.searchEndpoint||void 0,this.searchFunction=t.searchFunction||void 0,this.newItemFilter=t.newItemFilter||void 0,this.onChange=t.onChange||void 0,this.multiselect){let e=document.createElement("div");e.className=`${s}_badge-wrapper`,this.badgesWrapper=e,i.append(e)}else{let e=document.createElement("div");e.className=`${s}_input-wrapper ${s}_fake-input`,e.style.display="none",this.fakeInputWrapper=e;let t=document.createElement("div");t.className=`${s}_input form-control form-control-sm`,e.append(t),this.fakeInput=t;let a=document.createElement("div");a.className=`${s}_input-controls`;var n=document.createElement("div");n.className=`${s}_btn-delete ${s}_input-control`,this.required?n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>':n.innerHTML=o,n.addEventListener("click",(()=>{this.fakeInputWrapper.style.display="none",this.inputWrapper.style.display=null,this.required?this.openResults():this.clearValues()})),this.buttonFakeInput=n,a.append(n),e.append(a),i.append(e)}let r=document.createElement("div");r.className=`${s}_input-wrapper`,this.inputWrapper=r;let l=document.createElement("input");l.className=`${s}_input form-control form-control-sm`,l.type="text",this.placeholder&&(l.placeholder=this.placeholder),this.mainInput=l,r.append(l);let d=document.createElement("select");if(d.className=`${s}_select`,""!==this.formName&&(d.name=this.formName,this.multiselect&&(d.name+="[]",d.multiple=!0)),this.required&&(d.required=!0),r.append(d),this.formSelect=d,this.searchFunction||this.searchEndpoint){let e=document.createElement("div");e.className=`${s}_input-controls`;var c=document.createElement("div");c.className="spinner-border spinner-border-sm",c.style.display="none",e.append(c),this.loadSpinner=c,r.append(e)}i.append(r);let u=document.createElement("div");u.className=`${s}_popover shadow`,u.style.display="none",document.addEventListener("click",(e=>{e.target.closest(a)!==this.root&&this.closeResults()}));let m=document.createElement("div");m.className=`${s}_results`,u.append(m),this.results=m,i.append(u),this.popover=u,this.mainInput.addEventListener("focus",(()=>{this.openResults()})),this.mainInput.addEventListener("input",(()=>{this.openResults()})),this.mainInput.addEventListener("keyup",(e=>{"Enter"===e.code&&this.allowNew&&(e.preventDefault(),this.setItem(this.mainInput.value.trim()),this.closeResults())})),e.append(i),this.root=i,this.multiselect&&this.sortable&&window.app.loadModule("sortable").then((({default:e})=>{i.classList.add(`${s}--sortable`),new e.Sortable(this.badgesWrapper,{animation:150,handle:`${a}_badge-label`,ghostClass:`${s}_badge--ghost`,onUpdate:e=>{this.values.splice(e.newIndex,0,this.values.splice(e.oldIndex,1)[0]),this._regenSelect()}})})),t.values&&t.values.forEach((e=>{this.setItem(e)})),this._isInitialize=!0}openResults(){this.popover.style.display=null,this._filterSearch()}closeResults(){this.popover.style.display="none",this.required&&!this.multiselect&&0!==this.values.length&&(this.fakeInputWrapper.style.display=null,this.inputWrapper.style.display="none"),this.results.innerHTML=""}_filterSearch(){let e=this.mainInput.value.trim(),t=[];if(this.maxSize&&this.values.length>=this.maxSize)this._renderResults(t,e);else if("function"==typeof this.searchFunction||this.searchEndpoint)this.loadSpinner.style.display=null,void 0!==this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{let t;this.timer=void 0,t=this.searchFunction?this.searchFunction(e,this.values):(0,n.A)(this.searchEndpoint+new URLSearchParams({q:e,e:this.values})),t.then((t=>{this.items=t,this._renderResults(t,e)})).finally((()=>{this.loadSpinner.style.display="none"}))}),250);else{if(""===e&&0===this.values.length)t=this.items;else{let i=e.toLowerCase();this.items.forEach((e=>{let n,s=void 0!==e.value?e.value:e;if(-1!==this.values.indexOf(s))return;if(!e.searchString&&e.searchHTML){var a=document.createElement("div");a.innerHTML=e.searchHTML,n=a.innerText}let o=e.searchString||n||e.value||e;o=o.toString().toLowerCase(),-1!==o.indexOf(i)&&t.push(e)}))}this._renderResults(t,e)}}_renderResults(e,t){if(this.results.innerHTML="",this.maxSize&&this.values.length>=this.maxSize){let e=document.createElement("div");return e.className=`${s}_result-item`,e.innerHTML=this.limitPlaceholder,void this.results.append(e)}if(this.required&&!this.multiselect&&0!==this.values.length){let e=this.values[0],t=this._selectItems[e],i=document.createElement("div");i.className=`${s}_result-item`,i.setAttribute("data-label",this.selectedPlaceholder),i.innerHTML=t.searchHTML||t.value||t,i.addEventListener("click",(()=>{this.closeResults()})),this.results.append(i)}let i=null;if(this.allowNew&&""!==t&&(i="function"==typeof this.newItemFilter?this.newItemFilter(t):t,i)){let t=i.value||i;(-1!==this.values.indexOf(t)||e.find((e=>{if(e.value===t||e===t)return!0})))&&(i=null)}if(i){let e=document.createElement("div");e.className=`${s}_result-item`,e.setAttribute("data-label",this.newPlaceholder),e.innerHTML=i.searchHTML||i.value||i,e.addEventListener("click",(()=>{this.setItem(i),this.closeResults()})),this.results.append(e)}if(0!==e.length||i)e.forEach((e=>{let t=document.createElement("div");t.className=`${s}_result-item`,t.innerHTML=e.searchHTML||e.value||e,t.addEventListener("click",(()=>{this.setItem(e),this.closeResults()})),this.results.append(t)}));else{let e=document.createElement("div");e.className=`${s}_result-item`,e.innerHTML=this.emptyPlaceholder,this.results.append(e)}}getValues(){return this.values}setItem(e){if(this.maxSize&&this.values.length>=this.maxSize)return;let t=void 0!==e.value?e.value:e;if(-1!==this.values.indexOf(t))return;let i=this.items.find((e=>{if(e.value===t||e===t)return!0}));if(i)e=i;else if(this._isInitialize){if(!this.allowNew)return;if("function"==typeof this.newItemFilter&&!(e=this.newItemFilter(t)))return}if(this.multiselect){let i=document.createElement("div");i.className=`${s}_badge`;let n=document.createElement("div");n.innerHTML=e.badgeHTML||e.searchHTML||t,n.className=`${s}_badge-label`,i.append(n);let a=document.createElement("button");a.innerHTML=o,a.className=`${s}_badge-delete`,a.addEventListener("click",(()=>{this.removeValue(t),i.remove()})),i.append(a),this.badgesWrapper.append(i)}else this.clearValues(),this.fakeInput.innerHTML=e.badgeHTML||e.searchHTML||t.toString(),this.fakeInputWrapper.style.display=null,this.inputWrapper.style.display="none";this.values.push(t),this._selectItems[t]=e;let n=document.createElement("option");n.value=t,n.selected=!0,this.formSelect.append(n),this.mainInput.value="",this._isInitialize&&"function"==typeof this.onChange&&this.onChange(this)}removeValue(e){this.values=this.values.filter((t=>t!==e)),this._regenSelect(),this._isInitialize&&"function"==typeof this.onChange&&this.onChange(this)}clearValues(){this.values=[],this.formSelect.innerHTML="",this.results.innerHTML="",this.badgesWrapper&&(this.badgesWrapper.innerHTML=""),this._isInitialize&&"function"==typeof this.onChange&&this.onChange(this)}_regenSelect(){this.formSelect.innerHTML="",this.values.forEach((e=>{let t=document.createElement("option");t.value=e,t.selected=!0,this.formSelect.append(t)}))}}},86:(e,t,i)=>{i.d(t,{i:()=>o});var n=i(633),s=i(202);const a="/api/category_search";function o(e,t=[],i=void 0){return new n.A(e,{placeholder:window.app.l10n("tag-selector.placeholder"),emptyPlaceholder:window.app.l10n("tag-selector.empty"),newPlaceholder:window.app.l10n("tag-selector.new"),limitPlaceholder:window.app.l10n("tag-selector.limit",{limit:10}),maxSize:10,allowNew:"0"!==e.getAttribute("data-allow-custom"),multiselect:!0,sortable:!0,values:t,newItemFilter:e=>/[a-z-0-9-_ ]{2,32}/iu.test(e)?{value:e,searchHTML:"#"+e,badgeHTML:"#"+e}:null,searchFunction:async(e,t)=>{const i=await(0,s.A)(a+"?"+new URLSearchParams({q:e,e:t}));let n=[];return i.forEach((e=>{let t={};if(t.value=e.tag,t.badgeHTML=e.title,t.searchHTML=`<div class="select-category-title">${e.title}</div>`,e.desc&&(t.searchHTML+=`<div class="select-category-desc">${e.desc}</div>`),e.keywords&&e.keywords.length>0){let i="<span>"+e.keywords.join("</span><span>")+"</span>";t.searchHTML+=`<div class="select-category-keywords">${i}</div>`}n.push(t)})),n},onChange:i})}},267:(e,t,i)=>{i.d(t,{A:()=>a});var n=i(252),s=i(400);class a{constructor(e,t={}){if(this.root=e,this.nodes={formInput:this.root.querySelector(".comment-form_input"),fileButton:this.root.querySelector(".comment-form_upload-file"),imgPreloader:this.root.querySelector(".img-preloader"),imgAttach:this.root.querySelector(".comment-form_attach-img")},this.onSend=t.onSend||void 0,this.target=t.target,this.nodes.formInput){let e=parseInt(this.nodes.formInput.getAttribute("maxlength")),t=this.root.querySelector(".comment-form_limit"),i=()=>{t&&(this.nodes.formInput.value.length+50>e?t.textContent=`${this.nodes.formInput.value.length}/${e}`:t.textContent="",this.nodes.formInput.value.length>=e?t.classList.add("text-danger"):t.classList.remove("text-danger"))};this.nodes.formInput.addEventListener("input",i);let n=()=>{this.nodes.formInput.style.height=0,this.nodes.formInput.style.height=this.nodes.formInput.scrollHeight+"px"};this.root.resizeHeight=n,this.nodes.formInput.addEventListener("input",n)}if(this.nodes.fileButton){var i=new n.A;this.nodes.imgAttach.addEventListener("click",(()=>{this.nodes.fileButton.classList.remove("d-none"),this.root.removeAttribute("data-img-uuid"),this.nodes.imgAttach.classList.add("d-none"),this.nodes.imgAttach.style.backgroundImage=null}));var a=document.createElement("input");a.type="file",a.accept="image/png, image/jpeg, image/gif, image/webp",a.onchange=e=>{var t=e.target.files[0];this.nodes.fileButton.classList.add("d-none"),this.nodes.imgPreloader.classList.remove("d-none");var n=new FileReader;n.readAsDataURL(t),n.onload=e=>{this.nodes.imgPreloader.style.backgroundImage=`url(${e.target.result})`},i.upload(t,this.target).then((e=>{this.nodes.imgPreloader.classList.add("d-none"),this.nodes.imgAttach.classList.remove("d-none"),this.nodes.imgAttach.style.backgroundImage=`url(${e.file.url})`,this.root.setAttribute("data-img-uuid",e.file.uuid),a.value=""})).catch((e=>{this.nodes.imgPreloader.classList.add("d-none"),a.value="",window.app.error(e.message)}))},this.nodes.fileButton.addEventListener("click",(e=>{a.click()}))}var o=this.root.querySelector(".comment-form_send");o&&this.onSend&&(this._inProcess=!1,o.addEventListener("click",(e=>{if(this._inProcess)return;this._inProcess=!0;let t=o.innerText;o.innerHTML=s.A,o.disabled=!0;let i=this.getValues();this.onSend(i,this.root).then((e=>{this.clear()})).finally((e=>{this._inProcess=!1,o.innerText=t,o.disabled=!1}))})))}getValues(){let e={};this.root.hasAttribute("data-img-uuid")&&(e["img-uuid"]=this.root.getAttribute("data-img-uuid"));let t=this.root.querySelector(".comment-form_input").value.trim();return t.length>0&&(e.text=t),e}clear(){this.nodes.formInput&&(this.root.removeAttribute("data-img-uuid"),this.nodes.formInput.value="",this.nodes.fileButton.classList.remove("d-none"),this.nodes.imgPreloader.classList.add("d-none"),this.nodes.imgAttach.classList.add("d-none"))}}},193:(e,t,i)=>{i.d(t,{T:()=>r,Y:()=>o});var n=i(633),s=i(202);const a="/api/searchUnitCollection";function o(e){if("u"===e.type){let t={};t.value="u:"+e.id;let i=`<img class="icon" src="${e.preview_url}">`,n=`<img class="flag" src="/static/country_svg/country_${e.country_id}.svg">`,s=`<span>${e.country_name}</span>`,a=`<div class="title">${e.name}</div>`,o=["post-unit"];switch(e.exp_type){case 0:o.push("post-unit--regular");break;case 1:o.push("post-unit--prem");break;case 2:o.push("post-unit--squad")}let r=`<div class="${o.join(" ")}">${i}<div><div class="sub-cat">${n}${s}</div>${a}</div></div>`;return t.badgeHTML=r,t.searchHTML=r,t}if("c"===e.type){let t={};t.value="c:"+e.id;let i='<div class="icon"><i class="bi bi-folder2-open"></i></div>',n=`<div class="title">${e.title}</div>`,s=`<div class="post-unit">${i}<div><div class="sub-cat">${e.group_title}</div>${n}</div></div>`;return t.badgeHTML=s,t.searchHTML=s,t}return null}function r(e,t=[],i={}){return new n.A(e,{placeholder:window.app.l10n("unit-selector.placeholder"),emptyPlaceholder:window.app.l10n("unit-selector.empty"),limitPlaceholder:window.app.l10n("selector.limit"),maxSize:10,allowNew:!1,multiselect:!0,required:i.required??!1,values:t,searchFunction:async(e,t)=>{const i=await(0,s.A)(a+"?"+new URLSearchParams({q:e,e:t}));let n=[];return i.forEach((e=>{let t=o(e);null!==t&&n.push(t)})),n},onChange:i.onChange??void 0})}},252:(e,t,i)=>{i.d(t,{A:()=>s});var n=i(202);class s{upload(e,t=null){var i=new FormData;return i.append("image_file",e,"img"),i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t&&i.append("target",t),this._makeRequest(i)}async _makeRequest(e){return(0,n.A)("/api/upload",{method:"POST",credentials:"include",body:e}).then((e=>{if(e.success)return e;throw new Error(e.message)}))}}},282:(e,t,i)=>{i.d(t,{A:()=>n});class n{static render(e){let t=document.createElement("template");t.innerHTML=e;let i=t.content.firstChild;return i.querySelectorAll("[data-l10n-key]").forEach((e=>{let t=e.getAttribute("data-l10n-key");e.removeAttribute("data-l10n-key"),e.innerHTML=window.app.l10n(t)})),i}}},865:(e,t,i)=>{i.d(t,{A:()=>n});class n{constructor(e){this.node=e,this._firstDirection="asc",this._sortFunctions={};var t=e.querySelector(".wt-ulist_instance"),i=e.querySelectorAll(".wt-ulist_header th");i.forEach(((e,n)=>{if(!e.classList.contains("wt-ulist_header-button"))return;let s=null,a=e.hasAttribute("data-sort-key");s=a?e.getAttribute("data-sort-key"):n,this._sortFunctions[s]=o=>{var r="string";"n"===e.getAttribute("data-sort-type")&&(r="number");let l=Array.from(t.tBodies[0].rows).sort(((e,t)=>this._listSortFunction(e,t,n,r,o)));t.tBodies[0].append(...l),a?(this.setURLParam("l_sk",s),this.setURLParam("l_sd",o)):(this.setURLParam("l_sk",null),this.setURLParam("l_sd",null)),this._setHeaderDirection(i,e,o)},e.addEventListener("click",(()=>{var t=this._firstDirection;e.classList.contains("active--top")?t="asc":e.classList.contains("active--bottom")&&(t="desc"),this.listSort(s,t)}))})),null!==this.getURLParam("l_sk")&&this.listSort(this.getURLParam("l_sk"),this.getURLParam("l_sd"))}getURLParam(e){return new URL(window.location.href).searchParams.get(e)}setURLParam(e,t){var i=new URL(window.location.href);null===t?i.searchParams.delete(e):i.searchParams.set(e,t),window.history.replaceState(null,null,i)}listSort(e,t=this._firstDirection){this._sortFunctions.hasOwnProperty(e)&&this._sortFunctions[e](t)}_setHeaderDirection(e,t,i){e.forEach((e=>{e.classList.remove("active--top"),e.classList.remove("active--bottom")})),"asc"==i?t.classList.add("active--bottom"):t.classList.add("active--top")}_listSortFunction(e,t,i,n,s){"asc"!==s&&"desc"!==s&&(s=this._firstDirection);var a=e.cells[i],o=t.cells[i],r=a.hasAttribute("data-value")?a.getAttribute("data-value"):a.innerText,l=o.hasAttribute("data-value")?o.getAttribute("data-value"):o.innerText;if("number"==n&&(r=Number(r),l=Number(l)),r==l){var d=e.getAttribute("data-ulist-id"),c=t.getAttribute("data-ulist-id");return"asc"==s?d>c?1:-1:d<c?1:-1}return"asc"==s?r>l?1:-1:r<l?1:-1}}},25:(e,t,i)=>{i.d(t,{A:()=>a});var n=i(202),s=i(267);class a{constructor(){let e=document.getElementById("mainBlock"),t=document.querySelector(".comment-form");if(t){let i=parseInt(e.getAttribute("data-ticket-id"));this.commentForm=new s.A(t,{target:"ticket_"+i,onSend:async e=>{if(!("text"in e&&0!==e.text.trim().length||"img-uuid"in e))return window.app.warning(window.app.l10n("comment.error_empty")),Promise.reject();var t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("ticket_id",i),"text"in e&&t.append("text",e.text.trim()),"img-uuid"in e&&t.append("img-uuid",e["img-uuid"]),(0,n.A)("/api/ticketCommentSend",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?window.location.reload():window.app.error(e.message)}))}})}}}},503:(e,t,i)=>{i.d(t,{A:()=>s});var n=i(336);class s{static init(e){[...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map((e=>new n.Tooltip(e,{trigger:"hover"})))}}},59:(e,t,i)=>{i.d(t,{A:()=>n});class n{static init(){document.addEventListener("click",(e=>{let t=e.target.closest('[data-module="comment-mod"]');t&&i.e(189).then(i.bind(i,629)).then((({default:e})=>{let i=t.closest("[data-comment-id]");if(!i)return;let n=parseInt(i.getAttribute("data-comment-id"));e.getOrCreateInstance().open(n)})).catch((e=>{window.app.error(window.app.l10n("core.module-load-error")),console.error(e)}))}))}}},649:(e,t,i)=>{i.d(t,{A:()=>o});var n=i(336),s=i(282);class a{static _instance=null;static getOrCreateInstance(){return a._instance||(a._instance=new a),a._instance}constructor(){let e=s.A.render('<div class="modal fade" id="markdownHelpModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" data-l10n-key="markdown-help-popup.title"></h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="block-table"> <table class="mb-2 w-100"> <thead> <tr> <th data-l10n-key="markdown-help-popup.header-syntax"></th> <th data-l10n-key="markdown-help-popup.header-example"></th> </tr> </thead> <tbody> <tr> <td><code>**<span data-l10n-key="markdown-help-popup.label-bold"></span>**</code></td> <td> <div class="content-markdown fs-6"> <b data-l10n-key="markdown-help-popup.label-bold"></b> </div> </td> </tr> <tr> <td><code>*<span data-l10n-key="markdown-help-popup.label-italic"></span>*</code></td> <td> <div class="content-markdown fs-6"> <i data-l10n-key="markdown-help-popup.label-italic"></i> </div> </td> </tr> <tr> <td><code>&gt; <span data-l10n-key="markdown-help-popup.label-quote"></span></code></td> <td> <div class="content-markdown fs-6"> <blockquote data-l10n-key="markdown-help-popup.label-quote"></blockquote> </div> </td> </tr> <tr> <td><code>[<span data-l10n-key="markdown-help-popup.label-link"></span>](https://example.com)</code></td> <td> <div class="content-markdown fs-6"> <a href="https://example.com" target="_blank" data-l10n-key="markdown-help-popup.label-link"></a> </div> </td> </tr> </tbody> </table> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-l10n-key="button_close"></button> </div> </div> </div> </div>');document.body.appendChild(e),this.node=e,this.bsModal=n.Modal.getOrCreateInstance(e)}open(){this.bsModal.show()}}class o{static call(e){e.addEventListener("click",(e=>{a.getOrCreateInstance().open()}))}}},809:(e,t,i)=>{i.d(t,{A:()=>s});var n=i(865);class s{static call(e){return new n.A(e)}}}},e=>{e(e.s=997)}]);